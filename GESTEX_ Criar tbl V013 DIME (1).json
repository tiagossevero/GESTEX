[
{
  "model": "desktop.document2",
  "pk": 203322,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "GESTEX: Criar tbl V013 DIME",
    "description": "",
    "uuid": "61e9373b-dc7f-fe77-52a0-59e99c0ba023",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 203322, \"uuid\": \"1e228edb-27f2-4db5-8b5f-109d9489a0ff\", \"name\": \"GESTEX: Criar tbl V013 DIME\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"61e9373b-dc7f-fe77-52a0-59e99c0ba023\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"ef9e8d8e-6a89-e10e-1590-2394d66d95e5\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 676, \"column\": 67}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ================================================================\\r\\n-- GESTEX \\u2014 Projeto V013: DIME An\\u00e1lise Anual (2020\\u20132024)\\r\\n-- CRIA\\u00c7\\u00c3O DE TABELAS ANAL\\u00cdTICAS \\u2014 BigData Impala/Hue\\r\\n-- Schema: teste.gestex_v013_*\\r\\n-- Per\\u00edodo: 2020 a 2024\\r\\n-- ================================================================\\r\\n-- Fontes: usr_sat_ods.vw_ods_decl_dime | usr_sat_ods.vw_ods_contrib\\r\\n--         efd.efd (hier\\u00e1rquica E110/E111)\\r\\n--         efd.efd_rc100 / C170 (documentos fiscais)\\r\\n-- Padr\\u00e3o: implicit join para arrays EFD\\r\\n-- Refer\\u00eancia: Tabelas V014 j\\u00e1 validadas (teste.gestex_v014_*)\\r\\n-- ================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 1: CADASTRO GESTEX \\u2014 Contribuintes do setor t\\u00eaxtil ativos\\r\\n-- Fonte: usr_sat_ods.vw_ods_contrib\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A lista de CNAEs abaixo deve ser ajustada conforme a\\r\\n-- planilha CNAE_Subclasses_de_interesse_do_GESTEX.xlsx (coluna GESTEX='SIM').\\r\\n-- Os CNAEs listados s\\u00e3o representativos do setor t\\u00eaxtil/confec\\u00e7\\u00e3o.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cadastro;\\r\\nCREATE TABLE teste.gestex_v013_cadastro AS\\r\\nSELECT\\r\\n    c.nu_ie                               AS ie,\\r\\n    c.nu_cnpj                             AS cnpj,\\r\\n    c.nu_cnpj_grupo                       AS cnpj_raiz,\\r\\n    c.nm_razao_social                     AS razao_social,\\r\\n    c.nm_fantasia                         AS nome_fantasia,\\r\\n    c.cd_cnae                             AS cnae,\\r\\n    c.de_cnae                             AS cnae_desc,\\r\\n    c.cd_sit_cadastral                    AS cd_situacao,\\r\\n    c.nm_sit_cadastral                    AS situacao,\\r\\n    c.cd_reg_apuracao                     AS cd_regime,\\r\\n    c.nm_reg_apuracao                     AS regime_tributacao,\\r\\n    c.cd_enq_empresa                      AS cd_enquadramento,\\r\\n    c.nm_enq_empresa                      AS enquadramento,\\r\\n    c.cd_ges                              AS cd_ges,\\r\\n    c.nm_ges                              AS nome_ges,\\r\\n    c.cd_munic                            AS cd_municipio,\\r\\n    c.nm_munic                            AS municipio,\\r\\n    c.cd_uf                               AS uf,\\r\\n    c.sn_simples_nacional_rfb             AS ind_simples_nacional\\r\\nFROM usr_sat_ods.vw_ods_contrib c\\r\\nWHERE c.cd_cnae IN (\\r\\n    -- Fabrica\\u00e7\\u00e3o de produtos t\\u00eaxteis\\r\\n    1311100, 1312000, 1313800, 1314600, 1321900,\\r\\n    1322700, 1323500, 1330800, 1340500, 1351100,\\r\\n    1352900, 1353700, 1354500, 1359600,\\r\\n    -- Confec\\u00e7\\u00e3o de artigos do vestu\\u00e1rio e acess\\u00f3rios\\r\\n    1411801, 1411802, 1412601, 1412602, 1412603,\\r\\n    1413401, 1413402, 1413403, 1414200,\\r\\n    1421500, 1422300,\\r\\n    -- Acabamentos t\\u00eaxteis\\r\\n    1340501, 1340502, 1340503, 1340599\\r\\n    -- \\u26a0\\ufe0f COMPLETAR com todos os CNAEs da planilha GESTEX='SIM'\\r\\n)\\r\\n  AND c.cd_uf = 'SC'\\r\\n  AND c.cd_sit_cadastral = 1              -- 1 = ATIVA\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 2: DIME DADOS GERAIS \\u2014 Apura\\u00e7\\u00e3o anual por contribuinte\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime\\r\\n-- Cont\\u00e9m: faturamento, cr\\u00e9ditos, d\\u00e9bitos, ICMS recolhido\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_dados_gerais;\\r\\nCREATE TABLE teste.gestex_v013_dime_dados_gerais AS\\r\\nSELECT\\r\\n    d.nu_ie                                 AS ie,\\r\\n    d.nu_cnpj                               AS cnpj,\\r\\n    SUBSTR(d.nu_cnpj, 1, 8)                AS cnpj_raiz,\\r\\n    CAST(d.nu_ano_ref AS INT)               AS ano,\\r\\n    d.nu_per_ref                             AS mes,\\r\\n    -- Faturamento\\r\\n    COALESCE(d.vl_faturamento, 0)            AS vl_faturamento,\\r\\n    COALESCE(d.vl_receita_bruta, 0)          AS vl_receita_bruta,\\r\\n    -- Totais Entradas\\r\\n    COALESCE(d.vl_tot_ent_contabil, 0)       AS vl_tot_ent_contabil,\\r\\n    COALESCE(d.vl_tot_ent_bc, 0)             AS vl_tot_ent_bc,\\r\\n    COALESCE(d.vl_tot_ent_imposto_creditado, 0) AS vl_tot_ent_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_ent_isentas_nao_trib, 0)  AS vl_tot_ent_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_ent_outras, 0)         AS vl_tot_ent_outras,\\r\\n    -- Totais Sa\\u00eddas\\r\\n    COALESCE(d.vl_tot_sai_contabil, 0)       AS vl_tot_sai_contabil,\\r\\n    COALESCE(d.vl_tot_sai_bc, 0)             AS vl_tot_sai_bc,\\r\\n    COALESCE(d.vl_tot_sai_imposto_creditado, 0) AS vl_tot_sai_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_sai_isentas_nao_trib, 0)  AS vl_tot_sai_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_sai_outras, 0)         AS vl_tot_sai_outras,\\r\\n    -- Cr\\u00e9ditos e D\\u00e9bitos\\r\\n    COALESCE(d.vl_tot_cred, 0)               AS vl_tot_creditos,\\r\\n    COALESCE(d.vl_tot_deb, 0)                AS vl_tot_debitos,\\r\\n    COALESCE(d.vl_cred_mes_anterior, 0)      AS vl_cred_mes_anterior,\\r\\n    COALESCE(d.vl_cred_dcip, 0)              AS vl_cred_dcip,\\r\\n    COALESCE(d.vl_cred_mes_seguinte, 0)      AS vl_cred_mes_seguinte,\\r\\n    COALESCE(d.vl_deb_recolher, 0)           AS vl_deb_recolher,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    COALESCE(d.vl_saidas_internas, 0)        AS vl_saidas_internas,\\r\\n    COALESCE(d.vl_saidas_interestaduais, 0)  AS vl_saidas_interestaduais,\\r\\n    COALESCE(d.vl_exportacao, 0)             AS vl_exportacao,\\r\\n    -- Entradas por origem\\r\\n    COALESCE(d.vl_ent_int, 0)                AS vl_ent_internas,\\r\\n    COALESCE(d.vl_ent_ies, 0)                AS vl_ent_interestaduais,\\r\\n    COALESCE(d.vl_importacao, 0)             AS vl_importacao,\\r\\n    -- Substitui\\u00e7\\u00e3o Tribut\\u00e1ria\\r\\n    COALESCE(d.vl_tot_ent_bc_imposto_retido, 0) AS vl_ent_bc_st,\\r\\n    COALESCE(d.vl_tot_ent_imposto_retido, 0)    AS vl_ent_icms_st,\\r\\n    COALESCE(d.vl_tot_sai_bc_imposto_retido, 0) AS vl_sai_bc_st,\\r\\n    COALESCE(d.vl_tot_sai_imposto_retido, 0)    AS vl_sai_icms_st,\\r\\n    -- Funcion\\u00e1rios\\r\\n    d.qt_funcionarios\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nWHERE d.sn_cancelada = 0\\r\\n  AND CAST(d.nu_ano_ref AS INT) IN (2020, 2021, 2022, 2023, 2024)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 3: DIME DADOS GERAIS \\u2014 Sumarizado anual por CNPJ Raiz\\r\\n-- Agrupamento por sujeito passivo (CNPJ raiz) e ano\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_anual;\\r\\nCREATE TABLE teste.gestex_v013_dime_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    COUNT(DISTINCT ie)                      AS qtd_estabelecimentos,\\r\\n    SUM(vl_faturamento)                     AS faturamento_total,\\r\\n    SUM(vl_receita_bruta)                   AS receita_bruta_total,\\r\\n    SUM(vl_tot_sai_bc)                      AS bc_saidas_total,\\r\\n    SUM(vl_tot_ent_bc)                      AS bc_entradas_total,\\r\\n    SUM(vl_tot_debitos)                     AS debitos_total,\\r\\n    SUM(vl_tot_creditos)                    AS creditos_total,\\r\\n    SUM(vl_deb_recolher)                    AS icms_recolher_total,\\r\\n    SUM(vl_cred_dcip)                       AS cred_dcip_total,\\r\\n    SUM(vl_saidas_internas)                 AS saidas_internas,\\r\\n    SUM(vl_saidas_interestaduais)           AS saidas_interestaduais,\\r\\n    SUM(vl_exportacao)                      AS exportacao,\\r\\n    SUM(vl_ent_internas)                    AS entradas_internas,\\r\\n    SUM(vl_ent_interestaduais)              AS entradas_interestaduais,\\r\\n    SUM(vl_importacao)                      AS importacao\\r\\nFROM teste.gestex_v013_dime_dados_gerais\\r\\nGROUP BY cnpj_raiz, ano\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 4: APURA\\u00c7\\u00c3O EFD E110 \\u2014 ICMS Opera\\u00e7\\u00e3o Pr\\u00f3pria\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110)\\r\\n-- Todos os contribuintes SC, anos 2020\\u20132024\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e110;\\r\\nCREATE TABLE teste.gestex_v013_efd_e110 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.periodoreferencia,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_debitos        AS vl_tot_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_creditos       AS vl_tot_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_debitos     AS vl_tot_aj_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_creditos    AS vl_tot_aj_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_deb       AS vl_estornos_deb,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_cred      AS vl_estornos_cred,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_ant     AS vl_sld_credor_ant,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_apurado        AS vl_sld_apurado,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_ded            AS vl_tot_deducoes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_icms_recolher      AS vl_icms_recolher,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_transportar AS vl_sld_credor_transportar\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 5: AJUSTES EFD E111 \\u2014 Benef\\u00edcios e Incentivos ICMS\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110 \\u2192 E111)\\r\\n-- Inclui c\\u00f3digo de ajuste, descri\\u00e7\\u00e3o e valor\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e111;\\r\\nCREATE TABLE teste.gestex_v013_efd_e111 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    ajuste.cod_aj_apur,\\r\\n    ajuste.descr_compl_aj,\\r\\n    ajuste.vl_aj_apur\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo,\\r\\n     periodo.re110_apuracaoicms_operacaopropria.listare111_ajustebeneficioincentivo_icms ajuste\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 6: CR\\u00c9DITO PRESUMIDO (DCIP) \\u2014 Quem usou TTD 47/372/409-411\\r\\n-- Fonte: efd.efd \\u2192 E111\\r\\n-- Filtra ajustes de Cr\\u00e9dito Presumido pelo c\\u00f3digo SC\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os c\\u00f3digos de ajuste para CP no layout EFD SC s\\u00e3o:\\r\\n--   SC020047 = TTD 47  (art. 21, IX, Anexo 02)\\r\\n--   SC020372 = TTD 372 (art. 15, XXXIX, Anexo 02)\\r\\n--   SC020409 = TTD 409\\r\\n--   SC020410 = TTD 410\\r\\n--   SC020411 = TTD 411\\r\\n--   SC10xxxx = Cr\\u00e9dito presumido (Simples Nacional)\\r\\n--   Cr\\u00e9ditos extempor\\u00e2neos: cod_aj_apur LIKE 'SC1%' ou descr contendo 'EXTEMP'\\r\\n-- Caso a DIME possua tabela espec\\u00edfica de DCIP, usar em complemento.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip;\\r\\nCREATE TABLE teste.gestex_v013_dcip AS\\r\\nSELECT\\r\\n    cnpj,\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    mes,\\r\\n    cod_aj_apur,\\r\\n    descr_compl_aj,\\r\\n    vl_aj_apur                              AS vl_credito_presumido,\\r\\n    CASE\\r\\n        WHEN cod_aj_apur LIKE '%020047%' THEN 'TTD47'\\r\\n        WHEN cod_aj_apur LIKE '%020372%' THEN 'TTD372'\\r\\n        WHEN cod_aj_apur LIKE '%020409%' THEN 'TTD409'\\r\\n        WHEN cod_aj_apur LIKE '%020410%' THEN 'TTD410'\\r\\n        WHEN cod_aj_apur LIKE '%020411%' THEN 'TTD411'\\r\\n        ELSE 'OUTRO_CP'\\r\\n    END                                     AS tipo_beneficio,\\r\\n    CASE\\r\\n        WHEN UPPER(descr_compl_aj) LIKE '%EXTEMP%' THEN 1\\r\\n        ELSE 0\\r\\n    END                                     AS ind_extempraneo\\r\\nFROM teste.gestex_v013_efd_e111\\r\\nWHERE cod_aj_apur LIKE 'SC02%'\\r\\n   OR cod_aj_apur LIKE 'SC10%'\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 7: DCIP SUMARIZADA \\u2014 Total anual por CNPJ Raiz e tipo\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip_anual;\\r\\nCREATE TABLE teste.gestex_v013_dcip_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    tipo_beneficio,\\r\\n    SUM(vl_credito_presumido)               AS vl_cp_total,\\r\\n    COUNT(*)                                 AS qtd_registros,\\r\\n    MAX(ind_extempraneo)                     AS teve_extempraneo\\r\\nFROM teste.gestex_v013_dcip\\r\\nWHERE tipo_beneficio IN ('TTD47', 'TTD372', 'TTD409', 'TTD410', 'TTD411')\\r\\nGROUP BY cnpj_raiz, ano, tipo_beneficio\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 8: DOCUMENTOS FISCAIS C100/C170 \\u2014 Entradas e Sa\\u00eddas por CFOP\\r\\n-- Fonte: efd.efd_rc100 + C170 (implicit join)\\r\\n-- Sumarizado por identificadorarquivo, ano, m\\u00eas e CFOP\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_efd;\\r\\nCREATE TABLE teste.gestex_v013_cfop_efd AS\\r\\nSELECT\\r\\n    c.identificadorarquivo,\\r\\n    c.ano_referencia                         AS ano,\\r\\n    c.mes_referencia                         AS mes,\\r\\n    c.ind_oper,\\r\\n    it.cfop,\\r\\n    COUNT(*)                                 AS qtd_itens,\\r\\n    SUM(it.vl_item)                         AS vl_total,\\r\\n    SUM(it.vl_bc_icms)                      AS vl_bc_icms,\\r\\n    SUM(it.vl_icms)                         AS vl_icms\\r\\nFROM efd.efd_rc100 c, c.listarc170_itensdocumento it\\r\\nWHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND c.mes_referencia BETWEEN 1 AND 12\\r\\n  AND c.cod_sit = 0\\r\\nGROUP BY c.identificadorarquivo, c.ano_referencia, c.mes_referencia,\\r\\n         c.ind_oper, it.cfop\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 9: CFOP SUMARIZADA \\u2014 Categorias EInd/ECom/SInd/SCom\\r\\n-- por CNPJ Raiz e Ano (usa DIME como fonte principal)\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime (dados j\\u00e1 agrupados)\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A DIME j\\u00e1 cont\\u00e9m totais de entradas/sa\\u00eddas por tipo.\\r\\n-- Para granularidade por CFOP, usar teste.gestex_v013_cfop_efd.\\r\\n-- Esta tabela calcula os indicadores a partir da DIME diretamente.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_sumarizada;\\r\\nCREATE TABLE teste.gestex_v013_cfop_sumarizada AS\\r\\nSELECT\\r\\n    da.cnpj_raiz,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    -- Entradas por origem\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Total entradas e sa\\u00eddas\\r\\n    (da.entradas_internas + da.entradas_interestaduais + da.importacao) AS total_entradas,\\r\\n    (da.saidas_internas + da.saidas_interestaduais + da.exportacao)     AS total_saidas,\\r\\n    -- Percentuais\\r\\n    CASE WHEN (da.saidas_internas + da.saidas_interestaduais + da.exportacao) > 0\\r\\n         THEN da.exportacao / (da.saidas_internas + da.saidas_interestaduais + da.exportacao) * 100\\r\\n         ELSE 0 END                         AS pct_exportacao,\\r\\n    -- ICMS\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 10: BASE ANAL\\u00cdTICA GESTEX \\u2014 Cruza Cadastro + DIME + DCIP\\r\\n-- Apenas contribuintes GESTEX que usaram TTD 47 ou TTD 372\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_base_analitica;\\r\\nCREATE TABLE teste.gestex_v013_base_analitica AS\\r\\nSELECT\\r\\n    cad.ie,\\r\\n    cad.cnpj,\\r\\n    cad.cnpj_raiz,\\r\\n    cad.razao_social,\\r\\n    cad.cnae,\\r\\n    cad.cnae_desc,\\r\\n    cad.regime_tributacao,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total,\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Cr\\u00e9dito Presumido\\r\\n    dc47.vl_cp_total                         AS vl_cp_ttd47,\\r\\n    dc372.vl_cp_total                        AS vl_cp_ttd372,\\r\\n    COALESCE(dc47.vl_cp_total, 0) + COALESCE(dc372.vl_cp_total, 0) AS vl_cp_total,\\r\\n    CASE WHEN dc47.vl_cp_total IS NOT NULL AND dc372.vl_cp_total IS NOT NULL\\r\\n         THEN 'TTD47+TTD372'\\r\\n         WHEN dc47.vl_cp_total IS NOT NULL THEN 'TTD47'\\r\\n         WHEN dc372.vl_cp_total IS NOT NULL THEN 'TTD372'\\r\\n         ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cp,\\r\\n    -- TTDs adicionais (409/410/411)\\r\\n    dc409.vl_cp_total                        AS vl_cp_ttd409,\\r\\n    dc410.vl_cp_total                        AS vl_cp_ttd410,\\r\\n    dc411.vl_cp_total                        AS vl_cp_ttd411,\\r\\n    -- Extempor\\u00e2neo\\r\\n    COALESCE(dc47.teve_extempraneo, 0)       AS extempraneo_47,\\r\\n    COALESCE(dc372.teve_extempraneo, 0)      AS extempraneo_372\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\nINNER JOIN (\\r\\n    SELECT DISTINCT cnpj_raiz\\r\\n    FROM teste.gestex_v013_cadastro\\r\\n) cad_raiz ON da.cnpj_raiz = cad_raiz.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_cadastro cad\\r\\n    ON da.cnpj_raiz = cad.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc47\\r\\n    ON da.cnpj_raiz = dc47.cnpj_raiz\\r\\n    AND da.ano = dc47.ano\\r\\n    AND dc47.tipo_beneficio = 'TTD47'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc372\\r\\n    ON da.cnpj_raiz = dc372.cnpj_raiz\\r\\n    AND da.ano = dc372.ano\\r\\n    AND dc372.tipo_beneficio = 'TTD372'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc409\\r\\n    ON da.cnpj_raiz = dc409.cnpj_raiz\\r\\n    AND da.ano = dc409.ano\\r\\n    AND dc409.tipo_beneficio = 'TTD409'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc410\\r\\n    ON da.cnpj_raiz = dc410.cnpj_raiz\\r\\n    AND da.ano = dc410.ano\\r\\n    AND dc410.tipo_beneficio = 'TTD410'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc411\\r\\n    ON da.cnpj_raiz = dc411.cnpj_raiz\\r\\n    AND da.ano = dc411.ano\\r\\n    AND dc411.tipo_beneficio = 'TTD411'\\r\\nWHERE (dc47.vl_cp_total IS NOT NULL OR dc372.vl_cp_total IS NOT NULL)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 1: ICMS RECOLHIDO \\u2264 2% DA BASE DE C\\u00c1LCULO\\r\\n-- Detecta contribuintes com carga tribut\\u00e1ria muito baixa\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise1_icms_baixo;\\r\\nCREATE TABLE teste.gestex_v013_analise1_icms_baixo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.bc_saidas_total,\\r\\n    b.icms_recolher_total,\\r\\n    b.vl_cp_total,\\r\\n    CASE WHEN b.bc_saidas_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.bc_saidas_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_bc,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_faturamento,\\r\\n    'ICMS <= 2% DA BC'                       AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.bc_saidas_total > 0\\r\\n  AND (b.icms_recolher_total / b.bc_saidas_total) <= 0.02\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 2: ENTRADAS COMERCIAIS \\u00d7 SA\\u00cdDAS COMERCIAIS\\r\\n-- Indica poss\\u00edvel uso indevido do CP em produtos revendidos\\r\\n-- Crit\\u00e9rios: (a) Ent.Com \\u2265 20% total entradas\\r\\n--            (b) Raz\\u00e3o Ent.Com/Sa\\u00edda.Com \\u2265 3\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Como a DIME n\\u00e3o detalha por CFOP individual, esta an\\u00e1lise\\r\\n-- usa os totais da DIME (entradas interestaduais como proxy de comerciais).\\r\\n-- Para maior precis\\u00e3o, cruzar com teste.gestex_v013_cfop_efd.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise2_entradas_comerciais;\\r\\nCREATE TABLE teste.gestex_v013_analise2_entradas_comerciais AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.entradas_internas,\\r\\n    b.entradas_interestaduais,\\r\\n    b.importacao,\\r\\n    (b.entradas_internas + b.entradas_interestaduais + b.importacao) AS total_entradas,\\r\\n    b.saidas_internas,\\r\\n    b.saidas_interestaduais,\\r\\n    b.exportacao,\\r\\n    (b.saidas_internas + b.saidas_interestaduais + b.exportacao) AS total_saidas,\\r\\n    b.vl_cp_total,\\r\\n    -- \\u26a0\\ufe0f Quando houver dados por CFOP, substituir estes c\\u00e1lculos\\r\\n    -- pelos totais reais de CFOPs comerciais vs industriais\\r\\n    'REQUER DETALHAMENTO POR CFOP'           AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE (b.entradas_internas + b.entradas_interestaduais + b.importacao) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 3: CP SEM VENDA DE PRODU\\u00c7\\u00c3O PR\\u00d3PRIA\\r\\n-- Identifica SP que usaram CP sem faturamento com prod. pr\\u00f3pria\\r\\n-- Proxy: faturamento = 0 ou muito baixo relativo ao CP usado\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise3_cp_sem_producao;\\r\\nCREATE TABLE teste.gestex_v013_analise3_cp_sem_producao AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.faturamento_total,\\r\\n    b.receita_bruta_total,\\r\\n    b.vl_cp_total,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.vl_cp_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_cp_faturamento,\\r\\n    'CP SEM VENDA PROD. PROPRIA'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.faturamento_total = 0\\r\\n   OR b.faturamento_total IS NULL\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 4: CP CUMULATIVO (TTD47/372 + Simples Nac. ou Extempor\\u00e2neo)\\r\\n-- Identifica uso vedado ou que requer aten\\u00e7\\u00e3o especial\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise4_cp_cumulativo;\\r\\nCREATE TABLE teste.gestex_v013_analise4_cp_cumulativo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    b.vl_cp_total,\\r\\n    b.extempraneo_47,\\r\\n    b.extempraneo_372,\\r\\n    -- Cr\\u00e9ditos extempor\\u00e2neos totais\\r\\n    ext.vl_extempraneo_total,\\r\\n    -- Cr\\u00e9ditos Simples Nacional (via E111)\\r\\n    sn.vl_credito_sn_total,\\r\\n    CASE\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n             AND COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'EXTEMPRANEO + SIMPLES NACIONAL'\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n        THEN 'CREDITO EXTEMPRANEO'\\r\\n        WHEN COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'CP + SIMPLES NACIONAL'\\r\\n        ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cumulacao,\\r\\n    'CP CUMULATIVO'                          AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_credito_presumido)            AS vl_extempraneo_total\\r\\n    FROM teste.gestex_v013_dcip\\r\\n    WHERE ind_extempraneo = 1\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) ext ON b.cnpj_raiz = ext.cnpj_raiz AND b.ano = ext.ano\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_aj_apur)                     AS vl_credito_sn_total\\r\\n    FROM teste.gestex_v013_efd_e111\\r\\n    WHERE cod_aj_apur LIKE 'SC10%'\\r\\n       OR UPPER(descr_compl_aj) LIKE '%SIMPLES%NACIONAL%'\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) sn ON b.cnpj_raiz = sn.cnpj_raiz AND b.ano = sn.ano\\r\\nWHERE (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n   OR COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 5: Q9070 + 3% \\u00d7 BC DEVOLU\\u00c7\\u00d5ES = Q14031 (Exclusiva TTD 47)\\r\\n-- Verifica diferen\\u00e7a entre cr\\u00e9ditos permitidos e utilizados\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os campos item_9070 e item_14031 s\\u00e3o espec\\u00edficos dos\\r\\n-- quadros Q09 e Q14 da DIME. Na DIME do BigData (vw_ods_decl_dime),\\r\\n-- esses campos podem n\\u00e3o existir como colunas diretas.\\r\\n-- Se necess\\u00e1rio, calcular via E111 ou via tabela DIME espec\\u00edfica.\\r\\n--\\r\\n-- Para BC devolu\\u00e7\\u00f5es: somar C170 com CFOPs 1201, 2201, 1410, 2410\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise5_q9070_q14031;\\r\\nCREATE TABLE teste.gestex_v013_analise5_q9070_q14031 AS\\r\\nWITH devolucoes_venda AS (\\r\\n    SELECT\\r\\n        e.codigocnpj                         AS cnpj,\\r\\n        SUBSTR(e.codigocnpj, 1, 8)          AS cnpj_raiz,\\r\\n        c.ano_referencia                     AS ano,\\r\\n        SUM(c.vl_bc_icms)                   AS bc_devolucoes_venda\\r\\n    FROM efd.efd_rc100 c\\r\\n    INNER JOIN efd.efd e\\r\\n        ON c.id_file = e.id_file\\r\\n        AND c.ano_referencia = e.ano_referencia\\r\\n        AND c.mes_referencia = e.mes_referencia\\r\\n    WHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n      AND c.mes_referencia BETWEEN 1 AND 12\\r\\n      AND c.cod_sit = 0\\r\\n      AND c.ind_oper = 0                    -- Entrada\\r\\n      AND c.cod_mod = '55'                  -- NFe\\r\\n    GROUP BY e.codigocnpj, SUBSTR(e.codigocnpj, 1, 8), c.ano_referencia\\r\\n),\\r\\ndevolucoes_cfop AS (\\r\\n    SELECT\\r\\n        dv.cnpj_raiz,\\r\\n        dv.ano,\\r\\n        dv.bc_devolucoes_venda\\r\\n    FROM devolucoes_venda dv\\r\\n    -- \\u26a0\\ufe0f Idealmente filtrar por CFOP 1201, 2201, 1410, 2410\\r\\n    -- via C170 (listarc170_itensdocumento), mas o vl_bc_icms do C100\\r\\n    -- com ind_oper=0 j\\u00e1 cobre devolu\\u00e7\\u00f5es recebidas.\\r\\n    -- Para maior precis\\u00e3o, usar teste.gestex_v013_cfop_efd\\r\\n    -- filtrando por esses CFOPs espec\\u00edficos.\\r\\n)\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    dc.bc_devolucoes_venda,\\r\\n    0.03 * COALESCE(dc.bc_devolucoes_venda, 0) AS credito_3pct_devolucoes,\\r\\n    -- \\u26a0\\ufe0f Quando tiver os campos Q9070 e Q14031 da DIME, incluir:\\r\\n    -- item_9070 + 0.03 * bc_devolucoes - item_14031 AS diferenca\\r\\n    'REQUER CAMPOS Q9070/Q14031'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN devolucoes_cfop dc\\r\\n    ON b.cnpj_raiz = dc.cnpj_raiz\\r\\n    AND b.ano = dc.ano\\r\\nWHERE b.vl_cp_ttd47 IS NOT NULL\\r\\n  AND b.vl_cp_ttd47 > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- VALIDA\\u00c7\\u00c3O DAS TABELAS CRIADAS\\r\\n-- ================================================================\\r\\n\\r\\nSELECT 'teste.gestex_v013_cadastro' AS tabela, COUNT(*) AS registros FROM teste.gestex_v013_cadastro\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_dados_gerais', COUNT(*) FROM teste.gestex_v013_dime_dados_gerais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_anual', COUNT(*) FROM teste.gestex_v013_dime_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e110', COUNT(*) FROM teste.gestex_v013_efd_e110\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e111', COUNT(*) FROM teste.gestex_v013_efd_e111\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip', COUNT(*) FROM teste.gestex_v013_dcip\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip_anual', COUNT(*) FROM teste.gestex_v013_dcip_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_efd', COUNT(*) FROM teste.gestex_v013_cfop_efd\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_sumarizada', COUNT(*) FROM teste.gestex_v013_cfop_sumarizada\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_base_analitica', COUNT(*) FROM teste.gestex_v013_base_analitica\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise1_icms_baixo', COUNT(*) FROM teste.gestex_v013_analise1_icms_baixo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise2_entradas_comerciais', COUNT(*) FROM teste.gestex_v013_analise2_entradas_comerciais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise3_cp_sem_producao', COUNT(*) FROM teste.gestex_v013_analise3_cp_sem_producao\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise4_cp_cumulativo', COUNT(*) FROM teste.gestex_v013_analise4_cp_cumulativo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise5_q9070_q14031', COUNT(*) FROM teste.gestex_v013_analise5_q9070_q14031\\r\\nORDER BY 1;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- FIM \\u2014 15 tabelas no schema teste.gestex_v013_*\\r\\n-- ================================================================\\r\\n-- RESUMO DAS TABELAS:\\r\\n--  1. teste.gestex_v013_cadastro              \\u2192 Contribuintes GESTEX ativos\\r\\n--  2. teste.gestex_v013_dime_dados_gerais     \\u2192 DIME mensal (todos campos)\\r\\n--  3. teste.gestex_v013_dime_anual            \\u2192 DIME sumarizada por CNPJ Raiz/ano\\r\\n--  4. teste.gestex_v013_efd_e110              \\u2192 Apura\\u00e7\\u00e3o ICMS (E110) 2020-2024\\r\\n--  5. teste.gestex_v013_efd_e111              \\u2192 Ajustes/benef\\u00edcios (E111)\\r\\n--  6. teste.gestex_v013_dcip                  \\u2192 Cr\\u00e9ditos Presumidos classificados\\r\\n--  7. teste.gestex_v013_dcip_anual            \\u2192 DCIP sumarizada anual\\r\\n--  8. teste.gestex_v013_cfop_efd              \\u2192 Documentos por CFOP (C100/C170)\\r\\n--  9. teste.gestex_v013_cfop_sumarizada       \\u2192 Indicadores por CNPJ Raiz/ano\\r\\n-- 10. teste.gestex_v013_base_analitica        \\u2192 Base cruzada (Cadastro+DIME+DCIP)\\r\\n-- 11. teste.gestex_v013_analise1_icms_baixo   \\u2192 An.1: ICMS \\u2264 2% BC\\r\\n-- 12. teste.gestex_v013_analise2_entradas_com \\u2192 An.2: Ent.Com \\u00d7 Sa\\u00eddas Com\\r\\n-- 13. teste.gestex_v013_analise3_cp_sem_prod  \\u2192 An.3: CP sem produ\\u00e7\\u00e3o\\r\\n-- 14. teste.gestex_v013_analise4_cp_cumul     \\u2192 An.4: CP + SN/extempor\\u00e2neo\\r\\n-- 15. teste.gestex_v013_analise5_q9070_q14031 \\u2192 An.5: Verifica\\u00e7\\u00e3o Q9070/Q14031\\r\\n-- ================================================================\", \"statementsList\": [\"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 9: CFOP SUMARIZADA \\u2014 Categorias EInd/ECom/SInd/SCom\\r\\n-- por CNPJ Raiz e Ano (usa DIME como fonte principal)\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime (dados j\\u00e1 agrupados)\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A DIME j\\u00e1 cont\\u00e9m totais de entradas/sa\\u00eddas por tipo.\\r\\n-- Para granularidade por CFOP, usar teste.gestex_v013_cfop_efd.\\r\\n-- Esta tabela calcula os indicadores a partir da DIME diretamente.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_sumarizada;\", \"\\r\\nCREATE TABLE teste.gestex_v013_cfop_sumarizada AS\\r\\nSELECT\\r\\n    da.cnpj_raiz,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    -- Entradas por origem\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Total entradas e sa\\u00eddas\\r\\n    (da.entradas_internas + da.entradas_interestaduais + da.importacao) AS total_entradas,\\r\\n    (da.saidas_internas + da.saidas_interestaduais + da.exportacao)     AS total_saidas,\\r\\n    -- Percentuais\\r\\n    CASE WHEN (da.saidas_internas + da.saidas_interestaduais + da.exportacao) > 0\\r\\n         THEN da.exportacao / (da.saidas_internas + da.saidas_interestaduais + da.exportacao) * 100\\r\\n         ELSE 0 END                         AS pct_exportacao,\\r\\n    -- ICMS\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 10: BASE ANAL\\u00cdTICA GESTEX \\u2014 Cruza Cadastro + DIME + DCIP\\r\\n-- Apenas contribuintes GESTEX que usaram TTD 47 ou TTD 372\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_base_analitica;\", \"\\r\\nCREATE TABLE teste.gestex_v013_base_analitica AS\\r\\nSELECT\\r\\n    cad.ie,\\r\\n    cad.cnpj,\\r\\n    cad.cnpj_raiz,\\r\\n    cad.razao_social,\\r\\n    cad.cnae,\\r\\n    cad.cnae_desc,\\r\\n    cad.regime_tributacao,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total,\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Cr\\u00e9dito Presumido\\r\\n    dc47.vl_cp_total                         AS vl_cp_ttd47,\\r\\n    dc372.vl_cp_total                        AS vl_cp_ttd372,\\r\\n    COALESCE(dc47.vl_cp_total, 0) + COALESCE(dc372.vl_cp_total, 0) AS vl_cp_total,\\r\\n    CASE WHEN dc47.vl_cp_total IS NOT NULL AND dc372.vl_cp_total IS NOT NULL\\r\\n         THEN 'TTD47+TTD372'\\r\\n         WHEN dc47.vl_cp_total IS NOT NULL THEN 'TTD47'\\r\\n         WHEN dc372.vl_cp_total IS NOT NULL THEN 'TTD372'\\r\\n         ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cp,\\r\\n    -- TTDs adicionais (409/410/411)\\r\\n    dc409.vl_cp_total                        AS vl_cp_ttd409,\\r\\n    dc410.vl_cp_total                        AS vl_cp_ttd410,\\r\\n    dc411.vl_cp_total                        AS vl_cp_ttd411,\\r\\n    -- Extempor\\u00e2neo\\r\\n    COALESCE(dc47.teve_extempraneo, 0)       AS extempraneo_47,\\r\\n    COALESCE(dc372.teve_extempraneo, 0)      AS extempraneo_372\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\nINNER JOIN (\\r\\n    SELECT DISTINCT cnpj_raiz\\r\\n    FROM teste.gestex_v013_cadastro\\r\\n) cad_raiz ON da.cnpj_raiz = cad_raiz.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_cadastro cad\\r\\n    ON da.cnpj_raiz = cad.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc47\\r\\n    ON da.cnpj_raiz = dc47.cnpj_raiz\\r\\n    AND da.ano = dc47.ano\\r\\n    AND dc47.tipo_beneficio = 'TTD47'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc372\\r\\n    ON da.cnpj_raiz = dc372.cnpj_raiz\\r\\n    AND da.ano = dc372.ano\\r\\n    AND dc372.tipo_beneficio = 'TTD372'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc409\\r\\n    ON da.cnpj_raiz = dc409.cnpj_raiz\\r\\n    AND da.ano = dc409.ano\\r\\n    AND dc409.tipo_beneficio = 'TTD409'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc410\\r\\n    ON da.cnpj_raiz = dc410.cnpj_raiz\\r\\n    AND da.ano = dc410.ano\\r\\n    AND dc410.tipo_beneficio = 'TTD410'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc411\\r\\n    ON da.cnpj_raiz = dc411.cnpj_raiz\\r\\n    AND da.ano = dc411.ano\\r\\n    AND dc411.tipo_beneficio = 'TTD411'\\r\\nWHERE (dc47.vl_cp_total IS NOT NULL OR dc372.vl_cp_total IS NOT NULL)\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 1: ICMS RECOLHIDO \\u2264 2% DA BASE DE C\\u00c1LCULO\\r\\n-- Detecta contribuintes com carga tribut\\u00e1ria muito baixa\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise1_icms_baixo;\", \"\\r\\nCREATE TABLE teste.gestex_v013_analise1_icms_baixo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.bc_saidas_total,\\r\\n    b.icms_recolher_total,\\r\\n    b.vl_cp_total,\\r\\n    CASE WHEN b.bc_saidas_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.bc_saidas_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_bc,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_faturamento,\\r\\n    'ICMS <= 2% DA BC'                       AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.bc_saidas_total > 0\\r\\n  AND (b.icms_recolher_total / b.bc_saidas_total) <= 0.02\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 2: ENTRADAS COMERCIAIS \\u00d7 SA\\u00cdDAS COMERCIAIS\\r\\n-- Indica poss\\u00edvel uso indevido do CP em produtos revendidos\\r\\n-- Crit\\u00e9rios: (a) Ent.Com \\u2265 20% total entradas\\r\\n--            (b) Raz\\u00e3o Ent.Com/Sa\\u00edda.Com \\u2265 3\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Como a DIME n\\u00e3o detalha por CFOP individual, esta an\\u00e1lise\\r\\n-- usa os totais da DIME (entradas interestaduais como proxy de comerciais).\\r\\n-- Para maior precis\\u00e3o, cruzar com teste.gestex_v013_cfop_efd.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise2_entradas_comerciais;\", \"\\r\\nCREATE TABLE teste.gestex_v013_analise2_entradas_comerciais AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.entradas_internas,\\r\\n    b.entradas_interestaduais,\\r\\n    b.importacao,\\r\\n    (b.entradas_internas + b.entradas_interestaduais + b.importacao) AS total_entradas,\\r\\n    b.saidas_internas,\\r\\n    b.saidas_interestaduais,\\r\\n    b.exportacao,\\r\\n    (b.saidas_internas + b.saidas_interestaduais + b.exportacao) AS total_saidas,\\r\\n    b.vl_cp_total,\\r\\n    -- \\u26a0\\ufe0f Quando houver dados por CFOP, substituir estes c\\u00e1lculos\\r\\n    -- pelos totais reais de CFOPs comerciais vs industriais\\r\\n    'REQUER DETALHAMENTO POR CFOP'           AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE (b.entradas_internas + b.entradas_interestaduais + b.importacao) > 0\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 3: CP SEM VENDA DE PRODU\\u00c7\\u00c3O PR\\u00d3PRIA\\r\\n-- Identifica SP que usaram CP sem faturamento com prod. pr\\u00f3pria\\r\\n-- Proxy: faturamento = 0 ou muito baixo relativo ao CP usado\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise3_cp_sem_producao;\", \"\\r\\nCREATE TABLE teste.gestex_v013_analise3_cp_sem_producao AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.faturamento_total,\\r\\n    b.receita_bruta_total,\\r\\n    b.vl_cp_total,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.vl_cp_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_cp_faturamento,\\r\\n    'CP SEM VENDA PROD. PROPRIA'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.faturamento_total = 0\\r\\n   OR b.faturamento_total IS NULL\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 4: CP CUMULATIVO (TTD47/372 + Simples Nac. ou Extempor\\u00e2neo)\\r\\n-- Identifica uso vedado ou que requer aten\\u00e7\\u00e3o especial\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise4_cp_cumulativo;\", \"\\r\\nCREATE TABLE teste.gestex_v013_analise4_cp_cumulativo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    b.vl_cp_total,\\r\\n    b.extempraneo_47,\\r\\n    b.extempraneo_372,\\r\\n    -- Cr\\u00e9ditos extempor\\u00e2neos totais\\r\\n    ext.vl_extempraneo_total,\\r\\n    -- Cr\\u00e9ditos Simples Nacional (via E111)\\r\\n    sn.vl_credito_sn_total,\\r\\n    CASE\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n             AND COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'EXTEMPRANEO + SIMPLES NACIONAL'\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n        THEN 'CREDITO EXTEMPRANEO'\\r\\n        WHEN COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'CP + SIMPLES NACIONAL'\\r\\n        ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cumulacao,\\r\\n    'CP CUMULATIVO'                          AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_credito_presumido)            AS vl_extempraneo_total\\r\\n    FROM teste.gestex_v013_dcip\\r\\n    WHERE ind_extempraneo = 1\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) ext ON b.cnpj_raiz = ext.cnpj_raiz AND b.ano = ext.ano\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_aj_apur)                     AS vl_credito_sn_total\\r\\n    FROM teste.gestex_v013_efd_e111\\r\\n    WHERE cod_aj_apur LIKE 'SC10%'\\r\\n       OR UPPER(descr_compl_aj) LIKE '%SIMPLES%NACIONAL%'\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) sn ON b.cnpj_raiz = sn.cnpj_raiz AND b.ano = sn.ano\\r\\nWHERE (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n   OR COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 5: Q9070 + 3% \\u00d7 BC DEVOLU\\u00c7\\u00d5ES = Q14031 (Exclusiva TTD 47)\\r\\n-- Verifica diferen\\u00e7a entre cr\\u00e9ditos permitidos e utilizados\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os campos item_9070 e item_14031 s\\u00e3o espec\\u00edficos dos\\r\\n-- quadros Q09 e Q14 da DIME. Na DIME do BigData (vw_ods_decl_dime),\\r\\n-- esses campos podem n\\u00e3o existir como colunas diretas.\\r\\n-- Se necess\\u00e1rio, calcular via E111 ou via tabela DIME espec\\u00edfica.\\r\\n--\\r\\n-- Para BC devolu\\u00e7\\u00f5es: somar C170 com CFOPs 1201, 2201, 1410, 2410\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise5_q9070_q14031;\", \"\\r\\nCREATE TABLE teste.gestex_v013_analise5_q9070_q14031 AS\\r\\nWITH devolucoes_venda AS (\\r\\n    SELECT\\r\\n        e.codigocnpj                         AS cnpj,\\r\\n        SUBSTR(e.codigocnpj, 1, 8)          AS cnpj_raiz,\\r\\n        c.ano_referencia                     AS ano,\\r\\n        SUM(c.vl_bc_icms)                   AS bc_devolucoes_venda\\r\\n    FROM efd.efd_rc100 c\\r\\n    INNER JOIN efd.efd e\\r\\n        ON c.id_file = e.id_file\\r\\n        AND c.ano_referencia = e.ano_referencia\\r\\n        AND c.mes_referencia = e.mes_referencia\\r\\n    WHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n      AND c.mes_referencia BETWEEN 1 AND 12\\r\\n      AND c.cod_sit = 0\\r\\n      AND c.ind_oper = 0                    -- Entrada\\r\\n      AND c.cod_mod = '55'                  -- NFe\\r\\n    GROUP BY e.codigocnpj, SUBSTR(e.codigocnpj, 1, 8), c.ano_referencia\\r\\n),\\r\\ndevolucoes_cfop AS (\\r\\n    SELECT\\r\\n        dv.cnpj_raiz,\\r\\n        dv.ano,\\r\\n        dv.bc_devolucoes_venda\\r\\n    FROM devolucoes_venda dv\\r\\n    -- \\u26a0\\ufe0f Idealmente filtrar por CFOP 1201, 2201, 1410, 2410\\r\\n    -- via C170 (listarc170_itensdocumento), mas o vl_bc_icms do C100\\r\\n    -- com ind_oper=0 j\\u00e1 cobre devolu\\u00e7\\u00f5es recebidas.\\r\\n    -- Para maior precis\\u00e3o, usar teste.gestex_v013_cfop_efd\\r\\n    -- filtrando por esses CFOPs espec\\u00edficos.\\r\\n)\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    dc.bc_devolucoes_venda,\\r\\n    0.03 * COALESCE(dc.bc_devolucoes_venda, 0) AS credito_3pct_devolucoes,\\r\\n    -- \\u26a0\\ufe0f Quando tiver os campos Q9070 e Q14031 da DIME, incluir:\\r\\n    -- item_9070 + 0.03 * bc_devolucoes - item_14031 AS diferenca\\r\\n    'REQUER CAMPOS Q9070/Q14031'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN devolucoes_cfop dc\\r\\n    ON b.cnpj_raiz = dc.cnpj_raiz\\r\\n    AND b.ano = dc.ano\\r\\nWHERE b.vl_cp_ttd47 IS NOT NULL\\r\\n  AND b.vl_cp_ttd47 > 0\\r\\n;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- VALIDA\\u00c7\\u00c3O DAS TABELAS CRIADAS\\r\\n-- ================================================================\\r\\n\\r\\nSELECT 'teste.gestex_v013_cadastro' AS tabela, COUNT(*) AS registros FROM teste.gestex_v013_cadastro\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_dados_gerais', COUNT(*) FROM teste.gestex_v013_dime_dados_gerais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_anual', COUNT(*) FROM teste.gestex_v013_dime_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e110', COUNT(*) FROM teste.gestex_v013_efd_e110\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e111', COUNT(*) FROM teste.gestex_v013_efd_e111\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip', COUNT(*) FROM teste.gestex_v013_dcip\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip_anual', COUNT(*) FROM teste.gestex_v013_dcip_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_efd', COUNT(*) FROM teste.gestex_v013_cfop_efd\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_sumarizada', COUNT(*) FROM teste.gestex_v013_cfop_sumarizada\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_base_analitica', COUNT(*) FROM teste.gestex_v013_base_analitica\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise1_icms_baixo', COUNT(*) FROM teste.gestex_v013_analise1_icms_baixo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise2_entradas_comerciais', COUNT(*) FROM teste.gestex_v013_analise2_entradas_comerciais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise3_cp_sem_producao', COUNT(*) FROM teste.gestex_v013_analise3_cp_sem_producao\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise4_cp_cumulativo', COUNT(*) FROM teste.gestex_v013_analise4_cp_cumulativo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise5_q9070_q14031', COUNT(*) FROM teste.gestex_v013_analise5_q9070_q14031\\r\\nORDER BY 1;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- FIM \\u2014 15 tabelas no schema teste.gestex_v013_*\\r\\n-- ================================================================\\r\\n-- RESUMO DAS TABELAS:\\r\\n--  1. teste.gestex_v013_cadastro              \\u2192 Contribuintes GESTEX ativos\\r\\n--  2. teste.gestex_v013_dime_dados_gerais     \\u2192 DIME mensal (todos campos)\\r\\n--  3. teste.gestex_v013_dime_anual            \\u2192 DIME sumarizada por CNPJ Raiz/ano\\r\\n--  4. teste.gestex_v013_efd_e110              \\u2192 Apura\\u00e7\\u00e3o ICMS (E110) 2020-2024\\r\\n--  5. teste.gestex_v013_efd_e111              \\u2192 Ajustes/benef\\u00edcios (E111)\\r\\n--  6. teste.gestex_v013_dcip                  \\u2192 Cr\\u00e9ditos Presumidos classificados\\r\\n--  7. teste.gestex_v013_dcip_anual            \\u2192 DCIP sumarizada anual\\r\\n--  8. teste.gestex_v013_cfop_efd              \\u2192 Documentos por CFOP (C100/C170)\\r\\n--  9. teste.gestex_v013_cfop_sumarizada       \\u2192 Indicadores por CNPJ Raiz/ano\\r\\n-- 10. teste.gestex_v013_base_analitica        \\u2192 Base cruzada (Cadastro+DIME+DCIP)\\r\\n-- 11. teste.gestex_v013_analise1_icms_baixo   \\u2192 An.1: ICMS \\u2264 2% BC\\r\\n-- 12. teste.gestex_v013_analise2_entradas_com \\u2192 An.2: Ent.Com \\u00d7 Sa\\u00eddas Com\\r\\n-- 13. teste.gestex_v013_analise3_cp_sem_prod  \\u2192 An.3: CP sem produ\\u00e7\\u00e3o\\r\\n-- 14. teste.gestex_v013_analise4_cp_cumul     \\u2192 An.4: CP + SN/extempor\\u00e2neo\\r\\n-- 15. teste.gestex_v013_analise5_q9070_q14031 \\u2192 An.5: Verifica\\u00e7\\u00e3o Q9070/Q14031\\r\\n-- ================================================================\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ================================================================\\r\\n-- GESTEX \\u2014 Projeto V013: DIME An\\u00e1lise Anual (2020\\u20132024)\\r\\n-- CRIA\\u00c7\\u00c3O DE TABELAS ANAL\\u00cdTICAS \\u2014 BigData Impala/Hue\\r\\n-- Schema: teste.gestex_v013_*\\r\\n-- Per\\u00edodo: 2020 a 2024\\r\\n-- ================================================================\\r\\n-- Fontes: usr_sat_ods.vw_ods_decl_dime | usr_sat_ods.vw_ods_contrib\\r\\n--         efd.efd (hier\\u00e1rquica E110/E111)\\r\\n--         efd.efd_rc100 / C170 (documentos fiscais)\\r\\n-- Padr\\u00e3o: implicit join para arrays EFD\\r\\n-- Refer\\u00eancia: Tabelas V014 j\\u00e1 validadas (teste.gestex_v014_*)\\r\\n-- ================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 1: CADASTRO GESTEX \\u2014 Contribuintes do setor t\\u00eaxtil ativos\\r\\n-- Fonte: usr_sat_ods.vw_ods_contrib\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A lista de CNAEs abaixo deve ser ajustada conforme a\\r\\n-- planilha CNAE_Subclasses_de_interesse_do_GESTEX.xlsx (coluna GESTEX='SIM').\\r\\n-- Os CNAEs listados s\\u00e3o representativos do setor t\\u00eaxtil/confec\\u00e7\\u00e3o.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cadastro;\\r\\nCREATE TABLE teste.gestex_v013_cadastro AS\\r\\nSELECT\\r\\n    c.nu_ie                               AS ie,\\r\\n    c.nu_cnpj                             AS cnpj,\\r\\n    c.nu_cnpj_grupo                       AS cnpj_raiz,\\r\\n    c.nm_razao_social                     AS razao_social,\\r\\n    c.nm_fantasia                         AS nome_fantasia,\\r\\n    c.cd_cnae                             AS cnae,\\r\\n    c.de_cnae                             AS cnae_desc,\\r\\n    c.cd_sit_cadastral                    AS cd_situacao,\\r\\n    c.nm_sit_cadastral                    AS situacao,\\r\\n    c.cd_reg_apuracao                     AS cd_regime,\\r\\n    c.nm_reg_apuracao                     AS regime_tributacao,\\r\\n    c.cd_enq_empresa                      AS cd_enquadramento,\\r\\n    c.nm_enq_empresa                      AS enquadramento,\\r\\n    c.cd_ges                              AS cd_ges,\\r\\n    c.nm_ges                              AS nome_ges,\\r\\n    c.cd_munic                            AS cd_municipio,\\r\\n    c.nm_munic                            AS municipio,\\r\\n    c.cd_uf                               AS uf,\\r\\n    c.sn_simples_nacional_rfb             AS ind_simples_nacional\\r\\nFROM usr_sat_ods.vw_ods_contrib c\\r\\nWHERE c.cd_cnae IN (\\r\\n    -- Fabrica\\u00e7\\u00e3o de produtos t\\u00eaxteis\\r\\n    1311100, 1312000, 1313800, 1314600, 1321900,\\r\\n    1322700, 1323500, 1330800, 1340500, 1351100,\\r\\n    1352900, 1353700, 1354500, 1359600,\\r\\n    -- Confec\\u00e7\\u00e3o de artigos do vestu\\u00e1rio e acess\\u00f3rios\\r\\n    1411801, 1411802, 1412601, 1412602, 1412603,\\r\\n    1413401, 1413402, 1413403, 1414200,\\r\\n    1421500, 1422300,\\r\\n    -- Acabamentos t\\u00eaxteis\\r\\n    1340501, 1340502, 1340503, 1340599\\r\\n    -- \\u26a0\\ufe0f COMPLETAR com todos os CNAEs da planilha GESTEX='SIM'\\r\\n)\\r\\n  AND c.cd_uf = 'SC'\\r\\n  AND c.cd_sit_cadastral = 1              -- 1 = ATIVA\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 2: DIME DADOS GERAIS \\u2014 Apura\\u00e7\\u00e3o anual por contribuinte\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime\\r\\n-- Cont\\u00e9m: faturamento, cr\\u00e9ditos, d\\u00e9bitos, ICMS recolhido\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_dados_gerais;\\r\\nCREATE TABLE teste.gestex_v013_dime_dados_gerais AS\\r\\nSELECT\\r\\n    d.nu_ie                                 AS ie,\\r\\n    d.nu_cnpj                               AS cnpj,\\r\\n    SUBSTR(d.nu_cnpj, 1, 8)                AS cnpj_raiz,\\r\\n    CAST(d.nu_ano_ref AS INT)               AS ano,\\r\\n    d.nu_per_ref                             AS mes,\\r\\n    -- Faturamento\\r\\n    COALESCE(d.vl_faturamento, 0)            AS vl_faturamento,\\r\\n    COALESCE(d.vl_receita_bruta, 0)          AS vl_receita_bruta,\\r\\n    -- Totais Entradas\\r\\n    COALESCE(d.vl_tot_ent_contabil, 0)       AS vl_tot_ent_contabil,\\r\\n    COALESCE(d.vl_tot_ent_bc, 0)             AS vl_tot_ent_bc,\\r\\n    COALESCE(d.vl_tot_ent_imposto_creditado, 0) AS vl_tot_ent_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_ent_isentas_nao_trib, 0)  AS vl_tot_ent_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_ent_outras, 0)         AS vl_tot_ent_outras,\\r\\n    -- Totais Sa\\u00eddas\\r\\n    COALESCE(d.vl_tot_sai_contabil, 0)       AS vl_tot_sai_contabil,\\r\\n    COALESCE(d.vl_tot_sai_bc, 0)             AS vl_tot_sai_bc,\\r\\n    COALESCE(d.vl_tot_sai_imposto_creditado, 0) AS vl_tot_sai_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_sai_isentas_nao_trib, 0)  AS vl_tot_sai_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_sai_outras, 0)         AS vl_tot_sai_outras,\\r\\n    -- Cr\\u00e9ditos e D\\u00e9bitos\\r\\n    COALESCE(d.vl_tot_cred, 0)               AS vl_tot_creditos,\\r\\n    COALESCE(d.vl_tot_deb, 0)                AS vl_tot_debitos,\\r\\n    COALESCE(d.vl_cred_mes_anterior, 0)      AS vl_cred_mes_anterior,\\r\\n    COALESCE(d.vl_cred_dcip, 0)              AS vl_cred_dcip,\\r\\n    COALESCE(d.vl_cred_mes_seguinte, 0)      AS vl_cred_mes_seguinte,\\r\\n    COALESCE(d.vl_deb_recolher, 0)           AS vl_deb_recolher,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    COALESCE(d.vl_saidas_internas, 0)        AS vl_saidas_internas,\\r\\n    COALESCE(d.vl_saidas_interestaduais, 0)  AS vl_saidas_interestaduais,\\r\\n    COALESCE(d.vl_exportacao, 0)             AS vl_exportacao,\\r\\n    -- Entradas por origem\\r\\n    COALESCE(d.vl_ent_int, 0)                AS vl_ent_internas,\\r\\n    COALESCE(d.vl_ent_ies, 0)                AS vl_ent_interestaduais,\\r\\n    COALESCE(d.vl_importacao, 0)             AS vl_importacao,\\r\\n    -- Substitui\\u00e7\\u00e3o Tribut\\u00e1ria\\r\\n    COALESCE(d.vl_tot_ent_bc_imposto_retido, 0) AS vl_ent_bc_st,\\r\\n    COALESCE(d.vl_tot_ent_imposto_retido, 0)    AS vl_ent_icms_st,\\r\\n    COALESCE(d.vl_tot_sai_bc_imposto_retido, 0) AS vl_sai_bc_st,\\r\\n    COALESCE(d.vl_tot_sai_imposto_retido, 0)    AS vl_sai_icms_st,\\r\\n    -- Funcion\\u00e1rios\\r\\n    d.qt_funcionarios\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nWHERE d.sn_cancelada = 0\\r\\n  AND CAST(d.nu_ano_ref AS INT) IN (2020, 2021, 2022, 2023, 2024)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 3: DIME DADOS GERAIS \\u2014 Sumarizado anual por CNPJ Raiz\\r\\n-- Agrupamento por sujeito passivo (CNPJ raiz) e ano\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_anual;\\r\\nCREATE TABLE teste.gestex_v013_dime_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    COUNT(DISTINCT ie)                      AS qtd_estabelecimentos,\\r\\n    SUM(vl_faturamento)                     AS faturamento_total,\\r\\n    SUM(vl_receita_bruta)                   AS receita_bruta_total,\\r\\n    SUM(vl_tot_sai_bc)                      AS bc_saidas_total,\\r\\n    SUM(vl_tot_ent_bc)                      AS bc_entradas_total,\\r\\n    SUM(vl_tot_debitos)                     AS debitos_total,\\r\\n    SUM(vl_tot_creditos)                    AS creditos_total,\\r\\n    SUM(vl_deb_recolher)                    AS icms_recolher_total,\\r\\n    SUM(vl_cred_dcip)                       AS cred_dcip_total,\\r\\n    SUM(vl_saidas_internas)                 AS saidas_internas,\\r\\n    SUM(vl_saidas_interestaduais)           AS saidas_interestaduais,\\r\\n    SUM(vl_exportacao)                      AS exportacao,\\r\\n    SUM(vl_ent_internas)                    AS entradas_internas,\\r\\n    SUM(vl_ent_interestaduais)              AS entradas_interestaduais,\\r\\n    SUM(vl_importacao)                      AS importacao\\r\\nFROM teste.gestex_v013_dime_dados_gerais\\r\\nGROUP BY cnpj_raiz, ano\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 4: APURA\\u00c7\\u00c3O EFD E110 \\u2014 ICMS Opera\\u00e7\\u00e3o Pr\\u00f3pria\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110)\\r\\n-- Todos os contribuintes SC, anos 2020\\u20132024\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e110;\\r\\nCREATE TABLE teste.gestex_v013_efd_e110 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.periodoreferencia,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_debitos        AS vl_tot_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_creditos       AS vl_tot_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_debitos     AS vl_tot_aj_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_creditos    AS vl_tot_aj_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_deb       AS vl_estornos_deb,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_cred      AS vl_estornos_cred,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_ant     AS vl_sld_credor_ant,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_apurado        AS vl_sld_apurado,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_ded            AS vl_tot_deducoes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_icms_recolher      AS vl_icms_recolher,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_transportar AS vl_sld_credor_transportar\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 5: AJUSTES EFD E111 \\u2014 Benef\\u00edcios e Incentivos ICMS\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110 \\u2192 E111)\\r\\n-- Inclui c\\u00f3digo de ajuste, descri\\u00e7\\u00e3o e valor\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e111;\\r\\nCREATE TABLE teste.gestex_v013_efd_e111 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    ajuste.cod_aj_apur,\\r\\n    ajuste.descr_compl_aj,\\r\\n    ajuste.vl_aj_apur\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo,\\r\\n     periodo.re110_apuracaoicms_operacaopropria.listare111_ajustebeneficioincentivo_icms ajuste\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 6: CR\\u00c9DITO PRESUMIDO (DCIP) \\u2014 Quem usou TTD 47/372/409-411\\r\\n-- Fonte: efd.efd \\u2192 E111\\r\\n-- Filtra ajustes de Cr\\u00e9dito Presumido pelo c\\u00f3digo SC\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os c\\u00f3digos de ajuste para CP no layout EFD SC s\\u00e3o:\\r\\n--   SC020047 = TTD 47  (art. 21, IX, Anexo 02)\\r\\n--   SC020372 = TTD 372 (art. 15, XXXIX, Anexo 02)\\r\\n--   SC020409 = TTD 409\\r\\n--   SC020410 = TTD 410\\r\\n--   SC020411 = TTD 411\\r\\n--   SC10xxxx = Cr\\u00e9dito presumido (Simples Nacional)\\r\\n--   Cr\\u00e9ditos extempor\\u00e2neos: cod_aj_apur LIKE 'SC1%' ou descr contendo 'EXTEMP'\\r\\n-- Caso a DIME possua tabela espec\\u00edfica de DCIP, usar em complemento.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip;\\r\\nCREATE TABLE teste.gestex_v013_dcip AS\\r\\nSELECT\\r\\n    cnpj,\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    mes,\\r\\n    cod_aj_apur,\\r\\n    descr_compl_aj,\\r\\n    vl_aj_apur                              AS vl_credito_presumido,\\r\\n    CASE\\r\\n        WHEN cod_aj_apur LIKE '%020047%' THEN 'TTD47'\\r\\n        WHEN cod_aj_apur LIKE '%020372%' THEN 'TTD372'\\r\\n        WHEN cod_aj_apur LIKE '%020409%' THEN 'TTD409'\\r\\n        WHEN cod_aj_apur LIKE '%020410%' THEN 'TTD410'\\r\\n        WHEN cod_aj_apur LIKE '%020411%' THEN 'TTD411'\\r\\n        ELSE 'OUTRO_CP'\\r\\n    END                                     AS tipo_beneficio,\\r\\n    CASE\\r\\n        WHEN UPPER(descr_compl_aj) LIKE '%EXTEMP%' THEN 1\\r\\n        ELSE 0\\r\\n    END                                     AS ind_extempraneo\\r\\nFROM teste.gestex_v013_efd_e111\\r\\nWHERE cod_aj_apur LIKE 'SC02%'\\r\\n   OR cod_aj_apur LIKE 'SC10%'\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 7: DCIP SUMARIZADA \\u2014 Total anual por CNPJ Raiz e tipo\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip_anual;\\r\\nCREATE TABLE teste.gestex_v013_dcip_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    tipo_beneficio,\\r\\n    SUM(vl_credito_presumido)               AS vl_cp_total,\\r\\n    COUNT(*)                                 AS qtd_registros,\\r\\n    MAX(ind_extempraneo)                     AS teve_extempraneo\\r\\nFROM teste.gestex_v013_dcip\\r\\nWHERE tipo_beneficio IN ('TTD47', 'TTD372', 'TTD409', 'TTD410', 'TTD411')\\r\\nGROUP BY cnpj_raiz, ano, tipo_beneficio\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 8: DOCUMENTOS FISCAIS C100/C170 \\u2014 Entradas e Sa\\u00eddas por CFOP\\r\\n-- Fonte: efd.efd_rc100 + C170 (implicit join)\\r\\n-- Sumarizado por identificadorarquivo, ano, m\\u00eas e CFOP\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_efd;\\r\\nCREATE TABLE teste.gestex_v013_cfop_efd AS\\r\\nSELECT\\r\\n    c.identificadorarquivo,\\r\\n    c.ano_referencia                         AS ano,\\r\\n    c.mes_referencia                         AS mes,\\r\\n    c.ind_oper,\\r\\n    it.cfop,\\r\\n    COUNT(*)                                 AS qtd_itens,\\r\\n    SUM(it.vl_item)                         AS vl_total,\\r\\n    SUM(it.vl_bc_icms)                      AS vl_bc_icms,\\r\\n    SUM(it.vl_icms)                         AS vl_icms\\r\\nFROM efd.efd_rc100 c, c.listarc170_itensdocumento it\\r\\nWHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND c.mes_referencia BETWEEN 1 AND 12\\r\\n  AND c.cod_sit = 0\\r\\nGROUP BY c.identificadorarquivo, c.ano_referencia, c.mes_referencia,\\r\\n         c.ind_oper, it.cfop\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 9: CFOP SUMARIZADA \\u2014 Categorias EInd/ECom/SInd/SCom\\r\\n-- por CNPJ Raiz e Ano (usa DIME como fonte principal)\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime (dados j\\u00e1 agrupados)\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A DIME j\\u00e1 cont\\u00e9m totais de entradas/sa\\u00eddas por tipo.\\r\\n-- Para granularidade por CFOP, usar teste.gestex_v013_cfop_efd.\\r\\n-- Esta tabela calcula os indicadores a partir da DIME diretamente.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_sumarizada;\\r\\nCREATE TABLE teste.gestex_v013_cfop_sumarizada AS\\r\\nSELECT\\r\\n    da.cnpj_raiz,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    -- Entradas por origem\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Total entradas e sa\\u00eddas\\r\\n    (da.entradas_internas + da.entradas_interestaduais + da.importacao) AS total_entradas,\\r\\n    (da.saidas_internas + da.saidas_interestaduais + da.exportacao)     AS total_saidas,\\r\\n    -- Percentuais\\r\\n    CASE WHEN (da.saidas_internas + da.saidas_interestaduais + da.exportacao) > 0\\r\\n         THEN da.exportacao / (da.saidas_internas + da.saidas_interestaduais + da.exportacao) * 100\\r\\n         ELSE 0 END                         AS pct_exportacao,\\r\\n    -- ICMS\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 10: BASE ANAL\\u00cdTICA GESTEX \\u2014 Cruza Cadastro + DIME + DCIP\\r\\n-- Apenas contribuintes GESTEX que usaram TTD 47 ou TTD 372\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_base_analitica;\\r\\nCREATE TABLE teste.gestex_v013_base_analitica AS\\r\\nSELECT\\r\\n    cad.ie,\\r\\n    cad.cnpj,\\r\\n    cad.cnpj_raiz,\\r\\n    cad.razao_social,\\r\\n    cad.cnae,\\r\\n    cad.cnae_desc,\\r\\n    cad.regime_tributacao,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total,\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Cr\\u00e9dito Presumido\\r\\n    dc47.vl_cp_total                         AS vl_cp_ttd47,\\r\\n    dc372.vl_cp_total                        AS vl_cp_ttd372,\\r\\n    COALESCE(dc47.vl_cp_total, 0) + COALESCE(dc372.vl_cp_total, 0) AS vl_cp_total,\\r\\n    CASE WHEN dc47.vl_cp_total IS NOT NULL AND dc372.vl_cp_total IS NOT NULL\\r\\n         THEN 'TTD47+TTD372'\\r\\n         WHEN dc47.vl_cp_total IS NOT NULL THEN 'TTD47'\\r\\n         WHEN dc372.vl_cp_total IS NOT NULL THEN 'TTD372'\\r\\n         ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cp,\\r\\n    -- TTDs adicionais (409/410/411)\\r\\n    dc409.vl_cp_total                        AS vl_cp_ttd409,\\r\\n    dc410.vl_cp_total                        AS vl_cp_ttd410,\\r\\n    dc411.vl_cp_total                        AS vl_cp_ttd411,\\r\\n    -- Extempor\\u00e2neo\\r\\n    COALESCE(dc47.teve_extempraneo, 0)       AS extempraneo_47,\\r\\n    COALESCE(dc372.teve_extempraneo, 0)      AS extempraneo_372\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\nINNER JOIN (\\r\\n    SELECT DISTINCT cnpj_raiz\\r\\n    FROM teste.gestex_v013_cadastro\\r\\n) cad_raiz ON da.cnpj_raiz = cad_raiz.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_cadastro cad\\r\\n    ON da.cnpj_raiz = cad.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc47\\r\\n    ON da.cnpj_raiz = dc47.cnpj_raiz\\r\\n    AND da.ano = dc47.ano\\r\\n    AND dc47.tipo_beneficio = 'TTD47'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc372\\r\\n    ON da.cnpj_raiz = dc372.cnpj_raiz\\r\\n    AND da.ano = dc372.ano\\r\\n    AND dc372.tipo_beneficio = 'TTD372'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc409\\r\\n    ON da.cnpj_raiz = dc409.cnpj_raiz\\r\\n    AND da.ano = dc409.ano\\r\\n    AND dc409.tipo_beneficio = 'TTD409'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc410\\r\\n    ON da.cnpj_raiz = dc410.cnpj_raiz\\r\\n    AND da.ano = dc410.ano\\r\\n    AND dc410.tipo_beneficio = 'TTD410'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc411\\r\\n    ON da.cnpj_raiz = dc411.cnpj_raiz\\r\\n    AND da.ano = dc411.ano\\r\\n    AND dc411.tipo_beneficio = 'TTD411'\\r\\nWHERE (dc47.vl_cp_total IS NOT NULL OR dc372.vl_cp_total IS NOT NULL)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 1: ICMS RECOLHIDO \\u2264 2% DA BASE DE C\\u00c1LCULO\\r\\n-- Detecta contribuintes com carga tribut\\u00e1ria muito baixa\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise1_icms_baixo;\\r\\nCREATE TABLE teste.gestex_v013_analise1_icms_baixo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.bc_saidas_total,\\r\\n    b.icms_recolher_total,\\r\\n    b.vl_cp_total,\\r\\n    CASE WHEN b.bc_saidas_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.bc_saidas_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_bc,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_faturamento,\\r\\n    'ICMS <= 2% DA BC'                       AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.bc_saidas_total > 0\\r\\n  AND (b.icms_recolher_total / b.bc_saidas_total) <= 0.02\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 2: ENTRADAS COMERCIAIS \\u00d7 SA\\u00cdDAS COMERCIAIS\\r\\n-- Indica poss\\u00edvel uso indevido do CP em produtos revendidos\\r\\n-- Crit\\u00e9rios: (a) Ent.Com \\u2265 20% total entradas\\r\\n--            (b) Raz\\u00e3o Ent.Com/Sa\\u00edda.Com \\u2265 3\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Como a DIME n\\u00e3o detalha por CFOP individual, esta an\\u00e1lise\\r\\n-- usa os totais da DIME (entradas interestaduais como proxy de comerciais).\\r\\n-- Para maior precis\\u00e3o, cruzar com teste.gestex_v013_cfop_efd.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise2_entradas_comerciais;\\r\\nCREATE TABLE teste.gestex_v013_analise2_entradas_comerciais AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.entradas_internas,\\r\\n    b.entradas_interestaduais,\\r\\n    b.importacao,\\r\\n    (b.entradas_internas + b.entradas_interestaduais + b.importacao) AS total_entradas,\\r\\n    b.saidas_internas,\\r\\n    b.saidas_interestaduais,\\r\\n    b.exportacao,\\r\\n    (b.saidas_internas + b.saidas_interestaduais + b.exportacao) AS total_saidas,\\r\\n    b.vl_cp_total,\\r\\n    -- \\u26a0\\ufe0f Quando houver dados por CFOP, substituir estes c\\u00e1lculos\\r\\n    -- pelos totais reais de CFOPs comerciais vs industriais\\r\\n    'REQUER DETALHAMENTO POR CFOP'           AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE (b.entradas_internas + b.entradas_interestaduais + b.importacao) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 3: CP SEM VENDA DE PRODU\\u00c7\\u00c3O PR\\u00d3PRIA\\r\\n-- Identifica SP que usaram CP sem faturamento com prod. pr\\u00f3pria\\r\\n-- Proxy: faturamento = 0 ou muito baixo relativo ao CP usado\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise3_cp_sem_producao;\\r\\nCREATE TABLE teste.gestex_v013_analise3_cp_sem_producao AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.faturamento_total,\\r\\n    b.receita_bruta_total,\\r\\n    b.vl_cp_total,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.vl_cp_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_cp_faturamento,\\r\\n    'CP SEM VENDA PROD. PROPRIA'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.faturamento_total = 0\\r\\n   OR b.faturamento_total IS NULL\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 4: CP CUMULATIVO (TTD47/372 + Simples Nac. ou Extempor\\u00e2neo)\\r\\n-- Identifica uso vedado ou que requer aten\\u00e7\\u00e3o especial\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise4_cp_cumulativo;\\r\\nCREATE TABLE teste.gestex_v013_analise4_cp_cumulativo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    b.vl_cp_total,\\r\\n    b.extempraneo_47,\\r\\n    b.extempraneo_372,\\r\\n    -- Cr\\u00e9ditos extempor\\u00e2neos totais\\r\\n    ext.vl_extempraneo_total,\\r\\n    -- Cr\\u00e9ditos Simples Nacional (via E111)\\r\\n    sn.vl_credito_sn_total,\\r\\n    CASE\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n             AND COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'EXTEMPRANEO + SIMPLES NACIONAL'\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n        THEN 'CREDITO EXTEMPRANEO'\\r\\n        WHEN COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'CP + SIMPLES NACIONAL'\\r\\n        ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cumulacao,\\r\\n    'CP CUMULATIVO'                          AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_credito_presumido)            AS vl_extempraneo_total\\r\\n    FROM teste.gestex_v013_dcip\\r\\n    WHERE ind_extempraneo = 1\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) ext ON b.cnpj_raiz = ext.cnpj_raiz AND b.ano = ext.ano\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_aj_apur)                     AS vl_credito_sn_total\\r\\n    FROM teste.gestex_v013_efd_e111\\r\\n    WHERE cod_aj_apur LIKE 'SC10%'\\r\\n       OR UPPER(descr_compl_aj) LIKE '%SIMPLES%NACIONAL%'\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) sn ON b.cnpj_raiz = sn.cnpj_raiz AND b.ano = sn.ano\\r\\nWHERE (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n   OR COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 5: Q9070 + 3% \\u00d7 BC DEVOLU\\u00c7\\u00d5ES = Q14031 (Exclusiva TTD 47)\\r\\n-- Verifica diferen\\u00e7a entre cr\\u00e9ditos permitidos e utilizados\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os campos item_9070 e item_14031 s\\u00e3o espec\\u00edficos dos\\r\\n-- quadros Q09 e Q14 da DIME. Na DIME do BigData (vw_ods_decl_dime),\\r\\n-- esses campos podem n\\u00e3o existir como colunas diretas.\\r\\n-- Se necess\\u00e1rio, calcular via E111 ou via tabela DIME espec\\u00edfica.\\r\\n--\\r\\n-- Para BC devolu\\u00e7\\u00f5es: somar C170 com CFOPs 1201, 2201, 1410, 2410\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise5_q9070_q14031;\\r\\nCREATE TABLE teste.gestex_v013_analise5_q9070_q14031 AS\\r\\nWITH devolucoes_venda AS (\\r\\n    SELECT\\r\\n        e.codigocnpj                         AS cnpj,\\r\\n        SUBSTR(e.codigocnpj, 1, 8)          AS cnpj_raiz,\\r\\n        c.ano_referencia                     AS ano,\\r\\n        SUM(c.vl_bc_icms)                   AS bc_devolucoes_venda\\r\\n    FROM efd.efd_rc100 c\\r\\n    INNER JOIN efd.efd e\\r\\n        ON c.id_file = e.id_file\\r\\n        AND c.ano_referencia = e.ano_referencia\\r\\n        AND c.mes_referencia = e.mes_referencia\\r\\n    WHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n      AND c.mes_referencia BETWEEN 1 AND 12\\r\\n      AND c.cod_sit = 0\\r\\n      AND c.ind_oper = 0                    -- Entrada\\r\\n      AND c.cod_mod = '55'                  -- NFe\\r\\n    GROUP BY e.codigocnpj, SUBSTR(e.codigocnpj, 1, 8), c.ano_referencia\\r\\n),\\r\\ndevolucoes_cfop AS (\\r\\n    SELECT\\r\\n        dv.cnpj_raiz,\\r\\n        dv.ano,\\r\\n        dv.bc_devolucoes_venda\\r\\n    FROM devolucoes_venda dv\\r\\n    -- \\u26a0\\ufe0f Idealmente filtrar por CFOP 1201, 2201, 1410, 2410\\r\\n    -- via C170 (listarc170_itensdocumento), mas o vl_bc_icms do C100\\r\\n    -- com ind_oper=0 j\\u00e1 cobre devolu\\u00e7\\u00f5es recebidas.\\r\\n    -- Para maior precis\\u00e3o, usar teste.gestex_v013_cfop_efd\\r\\n    -- filtrando por esses CFOPs espec\\u00edficos.\\r\\n)\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    dc.bc_devolucoes_venda,\\r\\n    0.03 * COALESCE(dc.bc_devolucoes_venda, 0) AS credito_3pct_devolucoes,\\r\\n    -- \\u26a0\\ufe0f Quando tiver os campos Q9070 e Q14031 da DIME, incluir:\\r\\n    -- item_9070 + 0.03 * bc_devolucoes - item_14031 AS diferenca\\r\\n    'REQUER CAMPOS Q9070/Q14031'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN devolucoes_cfop dc\\r\\n    ON b.cnpj_raiz = dc.cnpj_raiz\\r\\n    AND b.ano = dc.ano\\r\\nWHERE b.vl_cp_ttd47 IS NOT NULL\\r\\n  AND b.vl_cp_ttd47 > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- VALIDA\\u00c7\\u00c3O DAS TABELAS CRIADAS\\r\\n-- ================================================================\\r\\n\\r\\nSELECT 'teste.gestex_v013_cadastro' AS tabela, COUNT(*) AS registros FROM teste.gestex_v013_cadastro\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_dados_gerais', COUNT(*) FROM teste.gestex_v013_dime_dados_gerais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_anual', COUNT(*) FROM teste.gestex_v013_dime_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e110', COUNT(*) FROM teste.gestex_v013_efd_e110\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e111', COUNT(*) FROM teste.gestex_v013_efd_e111\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip', COUNT(*) FROM teste.gestex_v013_dcip\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip_anual', COUNT(*) FROM teste.gestex_v013_dcip_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_efd', COUNT(*) FROM teste.gestex_v013_cfop_efd\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_sumarizada', COUNT(*) FROM teste.gestex_v013_cfop_sumarizada\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_base_analitica', COUNT(*) FROM teste.gestex_v013_base_analitica\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise1_icms_baixo', COUNT(*) FROM teste.gestex_v013_analise1_icms_baixo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise2_entradas_comerciais', COUNT(*) FROM teste.gestex_v013_analise2_entradas_comerciais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise3_cp_sem_producao', COUNT(*) FROM teste.gestex_v013_analise3_cp_sem_producao\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise4_cp_cumulativo', COUNT(*) FROM teste.gestex_v013_analise4_cp_cumulativo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise5_q9070_q14031', COUNT(*) FROM teste.gestex_v013_analise5_q9070_q14031\\r\\nORDER BY 1;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- FIM \\u2014 15 tabelas no schema teste.gestex_v013_*\\r\\n-- ================================================================\\r\\n-- RESUMO DAS TABELAS:\\r\\n--  1. teste.gestex_v013_cadastro              \\u2192 Contribuintes GESTEX ativos\\r\\n--  2. teste.gestex_v013_dime_dados_gerais     \\u2192 DIME mensal (todos campos)\\r\\n--  3. teste.gestex_v013_dime_anual            \\u2192 DIME sumarizada por CNPJ Raiz/ano\\r\\n--  4. teste.gestex_v013_efd_e110              \\u2192 Apura\\u00e7\\u00e3o ICMS (E110) 2020-2024\\r\\n--  5. teste.gestex_v013_efd_e111              \\u2192 Ajustes/benef\\u00edcios (E111)\\r\\n--  6. teste.gestex_v013_dcip                  \\u2192 Cr\\u00e9ditos Presumidos classificados\\r\\n--  7. teste.gestex_v013_dcip_anual            \\u2192 DCIP sumarizada anual\\r\\n--  8. teste.gestex_v013_cfop_efd              \\u2192 Documentos por CFOP (C100/C170)\\r\\n--  9. teste.gestex_v013_cfop_sumarizada       \\u2192 Indicadores por CNPJ Raiz/ano\\r\\n-- 10. teste.gestex_v013_base_analitica        \\u2192 Base cruzada (Cadastro+DIME+DCIP)\\r\\n-- 11. teste.gestex_v013_analise1_icms_baixo   \\u2192 An.1: ICMS \\u2264 2% BC\\r\\n-- 12. teste.gestex_v013_analise2_entradas_com \\u2192 An.2: Ent.Com \\u00d7 Sa\\u00eddas Com\\r\\n-- 13. teste.gestex_v013_analise3_cp_sem_prod  \\u2192 An.3: CP sem produ\\u00e7\\u00e3o\\r\\n-- 14. teste.gestex_v013_analise4_cp_cumul     \\u2192 An.4: CP + SN/extempor\\u00e2neo\\r\\n-- 15. teste.gestex_v013_analise5_q9070_q14031 \\u2192 An.5: Verifica\\u00e7\\u00e3o Q9070/Q14031\\r\\n-- ================================================================\", \"result\": {\"id\": \"55b582c8-5055-2310-b00b-3f1d029d84ba\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"mGccCRpGRI+1qsN+6F5P5Q==\", \"guid\": \"RdV929z3T4AAAAAA80PnKQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"d64827b133271b4a:b1d54212e4d7efa7\", \"session_id\": 26163, \"session_type\": \"impala\", \"statement_id\": 31, \"has_more_statements\": true, \"statements_count\": 33, \"previous_statement_hash\": \"1b36a268fb4300802e13ba52019e1875a22ac2925e0f5e3dcfc93ef4\", \"start\": {\"row\": 621, \"column\": 0}, \"end\": {\"row\": 654, \"column\": 11}, \"statement\": \"-- ================================================================\\n-- VALIDA\\u00c7\\u00c3O DAS TABELAS CRIADAS\\n-- ================================================================\\n\\nSELECT 'teste.gestex_v013_cadastro' AS tabela, COUNT(*) AS registros FROM teste.gestex_v013_cadastro\\nUNION ALL\\nSELECT 'teste.gestex_v013_dime_dados_gerais', COUNT(*) FROM teste.gestex_v013_dime_dados_gerais\\nUNION ALL\\nSELECT 'teste.gestex_v013_dime_anual', COUNT(*) FROM teste.gestex_v013_dime_anual\\nUNION ALL\\nSELECT 'teste.gestex_v013_efd_e110', COUNT(*) FROM teste.gestex_v013_efd_e110\\nUNION ALL\\nSELECT 'teste.gestex_v013_efd_e111', COUNT(*) FROM teste.gestex_v013_efd_e111\\nUNION ALL\\nSELECT 'teste.gestex_v013_dcip', COUNT(*) FROM teste.gestex_v013_dcip\\nUNION ALL\\nSELECT 'teste.gestex_v013_dcip_anual', COUNT(*) FROM teste.gestex_v013_dcip_anual\\nUNION ALL\\nSELECT 'teste.gestex_v013_cfop_efd', COUNT(*) FROM teste.gestex_v013_cfop_efd\\nUNION ALL\\nSELECT 'teste.gestex_v013_cfop_sumarizada', COUNT(*) FROM teste.gestex_v013_cfop_sumarizada\\nUNION ALL\\nSELECT 'teste.gestex_v013_base_analitica', COUNT(*) FROM teste.gestex_v013_base_analitica\\nUNION ALL\\nSELECT 'teste.gestex_v013_analise1_icms_baixo', COUNT(*) FROM teste.gestex_v013_analise1_icms_baixo\\nUNION ALL\\nSELECT 'teste.gestex_v013_analise2_entradas_comerciais', COUNT(*) FROM teste.gestex_v013_analise2_entradas_comerciais\\nUNION ALL\\nSELECT 'teste.gestex_v013_analise3_cp_sem_producao', COUNT(*) FROM teste.gestex_v013_analise3_cp_sem_producao\\nUNION ALL\\nSELECT 'teste.gestex_v013_analise4_cp_cumulativo', COUNT(*) FROM teste.gestex_v013_analise4_cp_cumulativo\\nUNION ALL\\nSELECT 'teste.gestex_v013_analise5_q9070_q14031', COUNT(*) FROM teste.gestex_v013_analise5_q9070_q14031\\nORDER BY 1\"}, \"meta\": [], \"rows\": 15, \"hasMore\": false, \"statement_id\": 31, \"statement_range\": {\"start\": {\"row\": 621, \"column\": 0}, \"end\": {\"row\": 654, \"column\": 11}}, \"statements_count\": 33, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 2, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"tabela\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"registros\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 2}], \"fetchedOnce\": false, \"startTime\": \"2026-02-18T20:49:08.840Z\", \"endTime\": \"2026-02-18T20:49:09.036Z\", \"executionTime\": 196, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 6, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 5020, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tabela\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"registros\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 5083, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1771447748515, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ================================================================\\r\\n-- GESTEX \\u2014 Projeto V013: DIME An\\u00e1lise Anual (2020\\u20132024)\\r\\n-- CRIA\\u00c7\\u00c3O DE TABELAS ANAL\\u00cdTICAS \\u2014 BigData Impala/Hue\\r\\n-- Schema: teste.gestex_v013_*\\r\\n-- Per\\u00edodo: 2020 a 2024\\r\\n-- ================================================================\\r\\n-- Fontes: usr_sat_ods.vw_ods_decl_dime | usr_sat_ods.vw_ods_contrib\\r\\n--         efd.efd (hier\\u00e1rquica E110/E111)\\r\\n--         efd.efd_rc100 / C170 (documentos fiscais)\\r\\n-- Padr\\u00e3o: implicit join para arrays EFD\\r\\n-- Refer\\u00eancia: Tabelas V014 j\\u00e1 validadas (teste.gestex_v014_*)\\r\\n-- ================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 1: CADASTRO GESTEX \\u2014 Contribuintes do setor t\\u00eaxtil ativos\\r\\n-- Fonte: usr_sat_ods.vw_ods_contrib\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A lista de CNAEs abaixo deve ser ajustada conforme a\\r\\n-- planilha CNAE_Subclasses_de_interesse_do_GESTEX.xlsx (coluna GESTEX='SIM').\\r\\n-- Os CNAEs listados s\\u00e3o representativos do setor t\\u00eaxtil/confec\\u00e7\\u00e3o.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cadastro;\\r\\nCREATE TABLE teste.gestex_v013_cadastro AS\\r\\nSELECT\\r\\n    c.nu_ie                               AS ie,\\r\\n    c.nu_cnpj                             AS cnpj,\\r\\n    c.nu_cnpj_grupo                       AS cnpj_raiz,\\r\\n    c.nm_razao_social                     AS razao_social,\\r\\n    c.nm_fantasia                         AS nome_fantasia,\\r\\n    c.cd_cnae                             AS cnae,\\r\\n    c.de_cnae                             AS cnae_desc,\\r\\n    c.cd_sit_cadastral                    AS cd_situacao,\\r\\n    c.nm_sit_cadastral                    AS situacao,\\r\\n    c.cd_reg_apuracao                     AS cd_regime,\\r\\n    c.nm_reg_apuracao                     AS regime_tributacao,\\r\\n    c.cd_enq_empresa                      AS cd_enquadramento,\\r\\n    c.nm_enq_empresa                      AS enquadramento,\\r\\n    c.cd_ges                              AS cd_ges,\\r\\n    c.nm_ges                              AS nome_ges,\\r\\n    c.cd_munic                            AS cd_municipio,\\r\\n    c.nm_munic                            AS municipio,\\r\\n    c.cd_uf                               AS uf,\\r\\n    c.sn_simples_nacional_rfb             AS ind_simples_nacional\\r\\nFROM usr_sat_ods.vw_ods_contrib c\\r\\nWHERE c.cd_cnae IN (\\r\\n    -- Fabrica\\u00e7\\u00e3o de produtos t\\u00eaxteis\\r\\n    1311100, 1312000, 1313800, 1314600, 1321900,\\r\\n    1322700, 1323500, 1330800, 1340500, 1351100,\\r\\n    1352900, 1353700, 1354500, 1359600,\\r\\n    -- Confec\\u00e7\\u00e3o de artigos do vestu\\u00e1rio e acess\\u00f3rios\\r\\n    1411801, 1411802, 1412601, 1412602, 1412603,\\r\\n    1413401, 1413402, 1413403, 1414200,\\r\\n    1421500, 1422300,\\r\\n    -- Acabamentos t\\u00eaxteis\\r\\n    1340501, 1340502, 1340503, 1340599\\r\\n    -- \\u26a0\\ufe0f COMPLETAR com todos os CNAEs da planilha GESTEX='SIM'\\r\\n)\\r\\n  AND c.cd_uf = 'SC'\\r\\n  AND c.cd_sit_cadastral = 1              -- 1 = ATIVA\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 2: DIME DADOS GERAIS \\u2014 Apura\\u00e7\\u00e3o anual por contribuinte\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime\\r\\n-- Cont\\u00e9m: faturamento, cr\\u00e9ditos, d\\u00e9bitos, ICMS recolhido\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_dados_gerais;\\r\\nCREATE TABLE teste.gestex_v013_dime_dados_gerais AS\\r\\nSELECT\\r\\n    d.nu_ie                                 AS ie,\\r\\n    d.nu_cnpj                               AS cnpj,\\r\\n    SUBSTR(d.nu_cnpj, 1, 8)                AS cnpj_raiz,\\r\\n    CAST(d.nu_ano_ref AS INT)               AS ano,\\r\\n    d.nu_per_ref                             AS mes,\\r\\n    -- Faturamento\\r\\n    COALESCE(d.vl_faturamento, 0)            AS vl_faturamento,\\r\\n    COALESCE(d.vl_receita_bruta, 0)          AS vl_receita_bruta,\\r\\n    -- Totais Entradas\\r\\n    COALESCE(d.vl_tot_ent_contabil, 0)       AS vl_tot_ent_contabil,\\r\\n    COALESCE(d.vl_tot_ent_bc, 0)             AS vl_tot_ent_bc,\\r\\n    COALESCE(d.vl_tot_ent_imposto_creditado, 0) AS vl_tot_ent_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_ent_isentas_nao_trib, 0)  AS vl_tot_ent_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_ent_outras, 0)         AS vl_tot_ent_outras,\\r\\n    -- Totais Sa\\u00eddas\\r\\n    COALESCE(d.vl_tot_sai_contabil, 0)       AS vl_tot_sai_contabil,\\r\\n    COALESCE(d.vl_tot_sai_bc, 0)             AS vl_tot_sai_bc,\\r\\n    COALESCE(d.vl_tot_sai_imposto_creditado, 0) AS vl_tot_sai_imposto_creditado,\\r\\n    COALESCE(d.vl_tot_sai_isentas_nao_trib, 0)  AS vl_tot_sai_isentas_nao_trib,\\r\\n    COALESCE(d.vl_tot_sai_outras, 0)         AS vl_tot_sai_outras,\\r\\n    -- Cr\\u00e9ditos e D\\u00e9bitos\\r\\n    COALESCE(d.vl_tot_cred, 0)               AS vl_tot_creditos,\\r\\n    COALESCE(d.vl_tot_deb, 0)                AS vl_tot_debitos,\\r\\n    COALESCE(d.vl_cred_mes_anterior, 0)      AS vl_cred_mes_anterior,\\r\\n    COALESCE(d.vl_cred_dcip, 0)              AS vl_cred_dcip,\\r\\n    COALESCE(d.vl_cred_mes_seguinte, 0)      AS vl_cred_mes_seguinte,\\r\\n    COALESCE(d.vl_deb_recolher, 0)           AS vl_deb_recolher,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    COALESCE(d.vl_saidas_internas, 0)        AS vl_saidas_internas,\\r\\n    COALESCE(d.vl_saidas_interestaduais, 0)  AS vl_saidas_interestaduais,\\r\\n    COALESCE(d.vl_exportacao, 0)             AS vl_exportacao,\\r\\n    -- Entradas por origem\\r\\n    COALESCE(d.vl_ent_int, 0)                AS vl_ent_internas,\\r\\n    COALESCE(d.vl_ent_ies, 0)                AS vl_ent_interestaduais,\\r\\n    COALESCE(d.vl_importacao, 0)             AS vl_importacao,\\r\\n    -- Substitui\\u00e7\\u00e3o Tribut\\u00e1ria\\r\\n    COALESCE(d.vl_tot_ent_bc_imposto_retido, 0) AS vl_ent_bc_st,\\r\\n    COALESCE(d.vl_tot_ent_imposto_retido, 0)    AS vl_ent_icms_st,\\r\\n    COALESCE(d.vl_tot_sai_bc_imposto_retido, 0) AS vl_sai_bc_st,\\r\\n    COALESCE(d.vl_tot_sai_imposto_retido, 0)    AS vl_sai_icms_st,\\r\\n    -- Funcion\\u00e1rios\\r\\n    d.qt_funcionarios\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nWHERE d.sn_cancelada = 0\\r\\n  AND CAST(d.nu_ano_ref AS INT) IN (2020, 2021, 2022, 2023, 2024)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 3: DIME DADOS GERAIS \\u2014 Sumarizado anual por CNPJ Raiz\\r\\n-- Agrupamento por sujeito passivo (CNPJ raiz) e ano\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dime_anual;\\r\\nCREATE TABLE teste.gestex_v013_dime_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    COUNT(DISTINCT ie)                      AS qtd_estabelecimentos,\\r\\n    SUM(vl_faturamento)                     AS faturamento_total,\\r\\n    SUM(vl_receita_bruta)                   AS receita_bruta_total,\\r\\n    SUM(vl_tot_sai_bc)                      AS bc_saidas_total,\\r\\n    SUM(vl_tot_ent_bc)                      AS bc_entradas_total,\\r\\n    SUM(vl_tot_debitos)                     AS debitos_total,\\r\\n    SUM(vl_tot_creditos)                    AS creditos_total,\\r\\n    SUM(vl_deb_recolher)                    AS icms_recolher_total,\\r\\n    SUM(vl_cred_dcip)                       AS cred_dcip_total,\\r\\n    SUM(vl_saidas_internas)                 AS saidas_internas,\\r\\n    SUM(vl_saidas_interestaduais)           AS saidas_interestaduais,\\r\\n    SUM(vl_exportacao)                      AS exportacao,\\r\\n    SUM(vl_ent_internas)                    AS entradas_internas,\\r\\n    SUM(vl_ent_interestaduais)              AS entradas_interestaduais,\\r\\n    SUM(vl_importacao)                      AS importacao\\r\\nFROM teste.gestex_v013_dime_dados_gerais\\r\\nGROUP BY cnpj_raiz, ano\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 4: APURA\\u00c7\\u00c3O EFD E110 \\u2014 ICMS Opera\\u00e7\\u00e3o Pr\\u00f3pria\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110)\\r\\n-- Todos os contribuintes SC, anos 2020\\u20132024\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e110;\\r\\nCREATE TABLE teste.gestex_v013_efd_e110 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.periodoreferencia,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_debitos        AS vl_tot_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_creditos       AS vl_tot_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_debitos     AS vl_tot_aj_debitos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_aj_creditos    AS vl_tot_aj_creditos,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_deb       AS vl_estornos_deb,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_estornos_cred      AS vl_estornos_cred,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_ant     AS vl_sld_credor_ant,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_apurado        AS vl_sld_apurado,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_tot_ded            AS vl_tot_deducoes,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_icms_recolher      AS vl_icms_recolher,\\r\\n    periodo.re110_apuracaoicms_operacaopropria.vl_sld_credor_transportar AS vl_sld_credor_transportar\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 5: AJUSTES EFD E111 \\u2014 Benef\\u00edcios e Incentivos ICMS\\r\\n-- Fonte: efd.efd (hier\\u00e1rquica \\u2192 blocoe \\u2192 E110 \\u2192 E111)\\r\\n-- Inclui c\\u00f3digo de ajuste, descri\\u00e7\\u00e3o e valor\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_efd_e111;\\r\\nCREATE TABLE teste.gestex_v013_efd_e111 AS\\r\\nSELECT\\r\\n    e.codigocnpj                                                     AS cnpj,\\r\\n    SUBSTR(e.codigocnpj, 1, 8)                                     AS cnpj_raiz,\\r\\n    e.ano_referencia                                                 AS ano,\\r\\n    e.mes_referencia                                                 AS mes,\\r\\n    ajuste.cod_aj_apur,\\r\\n    ajuste.descr_compl_aj,\\r\\n    ajuste.vl_aj_apur\\r\\nFROM efd.efd e,\\r\\n     e.efd.blocoe.listaperiodosapuracaoicms periodo,\\r\\n     periodo.re110_apuracaoicms_operacaopropria.listare111_ajustebeneficioincentivo_icms ajuste\\r\\nWHERE e.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND e.mes_referencia BETWEEN 1 AND 12\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 6: CR\\u00c9DITO PRESUMIDO (DCIP) \\u2014 Quem usou TTD 47/372/409-411\\r\\n-- Fonte: efd.efd \\u2192 E111\\r\\n-- Filtra ajustes de Cr\\u00e9dito Presumido pelo c\\u00f3digo SC\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os c\\u00f3digos de ajuste para CP no layout EFD SC s\\u00e3o:\\r\\n--   SC020047 = TTD 47  (art. 21, IX, Anexo 02)\\r\\n--   SC020372 = TTD 372 (art. 15, XXXIX, Anexo 02)\\r\\n--   SC020409 = TTD 409\\r\\n--   SC020410 = TTD 410\\r\\n--   SC020411 = TTD 411\\r\\n--   SC10xxxx = Cr\\u00e9dito presumido (Simples Nacional)\\r\\n--   Cr\\u00e9ditos extempor\\u00e2neos: cod_aj_apur LIKE 'SC1%' ou descr contendo 'EXTEMP'\\r\\n-- Caso a DIME possua tabela espec\\u00edfica de DCIP, usar em complemento.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip;\\r\\nCREATE TABLE teste.gestex_v013_dcip AS\\r\\nSELECT\\r\\n    cnpj,\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    mes,\\r\\n    cod_aj_apur,\\r\\n    descr_compl_aj,\\r\\n    vl_aj_apur                              AS vl_credito_presumido,\\r\\n    CASE\\r\\n        WHEN cod_aj_apur LIKE '%020047%' THEN 'TTD47'\\r\\n        WHEN cod_aj_apur LIKE '%020372%' THEN 'TTD372'\\r\\n        WHEN cod_aj_apur LIKE '%020409%' THEN 'TTD409'\\r\\n        WHEN cod_aj_apur LIKE '%020410%' THEN 'TTD410'\\r\\n        WHEN cod_aj_apur LIKE '%020411%' THEN 'TTD411'\\r\\n        ELSE 'OUTRO_CP'\\r\\n    END                                     AS tipo_beneficio,\\r\\n    CASE\\r\\n        WHEN UPPER(descr_compl_aj) LIKE '%EXTEMP%' THEN 1\\r\\n        ELSE 0\\r\\n    END                                     AS ind_extempraneo\\r\\nFROM teste.gestex_v013_efd_e111\\r\\nWHERE cod_aj_apur LIKE 'SC02%'\\r\\n   OR cod_aj_apur LIKE 'SC10%'\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 7: DCIP SUMARIZADA \\u2014 Total anual por CNPJ Raiz e tipo\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_dcip_anual;\\r\\nCREATE TABLE teste.gestex_v013_dcip_anual AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    ano,\\r\\n    tipo_beneficio,\\r\\n    SUM(vl_credito_presumido)               AS vl_cp_total,\\r\\n    COUNT(*)                                 AS qtd_registros,\\r\\n    MAX(ind_extempraneo)                     AS teve_extempraneo\\r\\nFROM teste.gestex_v013_dcip\\r\\nWHERE tipo_beneficio IN ('TTD47', 'TTD372', 'TTD409', 'TTD410', 'TTD411')\\r\\nGROUP BY cnpj_raiz, ano, tipo_beneficio\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 8: DOCUMENTOS FISCAIS C100/C170 \\u2014 Entradas e Sa\\u00eddas por CFOP\\r\\n-- Fonte: efd.efd_rc100 + C170 (implicit join)\\r\\n-- Sumarizado por identificadorarquivo, ano, m\\u00eas e CFOP\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_efd;\\r\\nCREATE TABLE teste.gestex_v013_cfop_efd AS\\r\\nSELECT\\r\\n    c.identificadorarquivo,\\r\\n    c.ano_referencia                         AS ano,\\r\\n    c.mes_referencia                         AS mes,\\r\\n    c.ind_oper,\\r\\n    it.cfop,\\r\\n    COUNT(*)                                 AS qtd_itens,\\r\\n    SUM(it.vl_item)                         AS vl_total,\\r\\n    SUM(it.vl_bc_icms)                      AS vl_bc_icms,\\r\\n    SUM(it.vl_icms)                         AS vl_icms\\r\\nFROM efd.efd_rc100 c, c.listarc170_itensdocumento it\\r\\nWHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n  AND c.mes_referencia BETWEEN 1 AND 12\\r\\n  AND c.cod_sit = 0\\r\\nGROUP BY c.identificadorarquivo, c.ano_referencia, c.mes_referencia,\\r\\n         c.ind_oper, it.cfop\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 9: CFOP SUMARIZADA \\u2014 Categorias EInd/ECom/SInd/SCom\\r\\n-- por CNPJ Raiz e Ano (usa DIME como fonte principal)\\r\\n-- Fonte: usr_sat_ods.vw_ods_decl_dime (dados j\\u00e1 agrupados)\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: A DIME j\\u00e1 cont\\u00e9m totais de entradas/sa\\u00eddas por tipo.\\r\\n-- Para granularidade por CFOP, usar teste.gestex_v013_cfop_efd.\\r\\n-- Esta tabela calcula os indicadores a partir da DIME diretamente.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_cfop_sumarizada;\\r\\nCREATE TABLE teste.gestex_v013_cfop_sumarizada AS\\r\\nSELECT\\r\\n    da.cnpj_raiz,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    -- Sa\\u00eddas por destino\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    -- Entradas por origem\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Total entradas e sa\\u00eddas\\r\\n    (da.entradas_internas + da.entradas_interestaduais + da.importacao) AS total_entradas,\\r\\n    (da.saidas_internas + da.saidas_interestaduais + da.exportacao)     AS total_saidas,\\r\\n    -- Percentuais\\r\\n    CASE WHEN (da.saidas_internas + da.saidas_interestaduais + da.exportacao) > 0\\r\\n         THEN da.exportacao / (da.saidas_internas + da.saidas_interestaduais + da.exportacao) * 100\\r\\n         ELSE 0 END                         AS pct_exportacao,\\r\\n    -- ICMS\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- TABELA 10: BASE ANAL\\u00cdTICA GESTEX \\u2014 Cruza Cadastro + DIME + DCIP\\r\\n-- Apenas contribuintes GESTEX que usaram TTD 47 ou TTD 372\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_base_analitica;\\r\\nCREATE TABLE teste.gestex_v013_base_analitica AS\\r\\nSELECT\\r\\n    cad.ie,\\r\\n    cad.cnpj,\\r\\n    cad.cnpj_raiz,\\r\\n    cad.razao_social,\\r\\n    cad.cnae,\\r\\n    cad.cnae_desc,\\r\\n    cad.regime_tributacao,\\r\\n    da.ano,\\r\\n    da.faturamento_total,\\r\\n    da.receita_bruta_total,\\r\\n    da.bc_saidas_total,\\r\\n    da.bc_entradas_total,\\r\\n    da.debitos_total,\\r\\n    da.creditos_total,\\r\\n    da.icms_recolher_total,\\r\\n    da.cred_dcip_total,\\r\\n    da.saidas_internas,\\r\\n    da.saidas_interestaduais,\\r\\n    da.exportacao,\\r\\n    da.entradas_internas,\\r\\n    da.entradas_interestaduais,\\r\\n    da.importacao,\\r\\n    -- Cr\\u00e9dito Presumido\\r\\n    dc47.vl_cp_total                         AS vl_cp_ttd47,\\r\\n    dc372.vl_cp_total                        AS vl_cp_ttd372,\\r\\n    COALESCE(dc47.vl_cp_total, 0) + COALESCE(dc372.vl_cp_total, 0) AS vl_cp_total,\\r\\n    CASE WHEN dc47.vl_cp_total IS NOT NULL AND dc372.vl_cp_total IS NOT NULL\\r\\n         THEN 'TTD47+TTD372'\\r\\n         WHEN dc47.vl_cp_total IS NOT NULL THEN 'TTD47'\\r\\n         WHEN dc372.vl_cp_total IS NOT NULL THEN 'TTD372'\\r\\n         ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cp,\\r\\n    -- TTDs adicionais (409/410/411)\\r\\n    dc409.vl_cp_total                        AS vl_cp_ttd409,\\r\\n    dc410.vl_cp_total                        AS vl_cp_ttd410,\\r\\n    dc411.vl_cp_total                        AS vl_cp_ttd411,\\r\\n    -- Extempor\\u00e2neo\\r\\n    COALESCE(dc47.teve_extempraneo, 0)       AS extempraneo_47,\\r\\n    COALESCE(dc372.teve_extempraneo, 0)      AS extempraneo_372\\r\\nFROM teste.gestex_v013_dime_anual da\\r\\nINNER JOIN (\\r\\n    SELECT DISTINCT cnpj_raiz\\r\\n    FROM teste.gestex_v013_cadastro\\r\\n) cad_raiz ON da.cnpj_raiz = cad_raiz.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_cadastro cad\\r\\n    ON da.cnpj_raiz = cad.cnpj_raiz\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc47\\r\\n    ON da.cnpj_raiz = dc47.cnpj_raiz\\r\\n    AND da.ano = dc47.ano\\r\\n    AND dc47.tipo_beneficio = 'TTD47'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc372\\r\\n    ON da.cnpj_raiz = dc372.cnpj_raiz\\r\\n    AND da.ano = dc372.ano\\r\\n    AND dc372.tipo_beneficio = 'TTD372'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc409\\r\\n    ON da.cnpj_raiz = dc409.cnpj_raiz\\r\\n    AND da.ano = dc409.ano\\r\\n    AND dc409.tipo_beneficio = 'TTD409'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc410\\r\\n    ON da.cnpj_raiz = dc410.cnpj_raiz\\r\\n    AND da.ano = dc410.ano\\r\\n    AND dc410.tipo_beneficio = 'TTD410'\\r\\nLEFT JOIN teste.gestex_v013_dcip_anual dc411\\r\\n    ON da.cnpj_raiz = dc411.cnpj_raiz\\r\\n    AND da.ano = dc411.ano\\r\\n    AND dc411.tipo_beneficio = 'TTD411'\\r\\nWHERE (dc47.vl_cp_total IS NOT NULL OR dc372.vl_cp_total IS NOT NULL)\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 1: ICMS RECOLHIDO \\u2264 2% DA BASE DE C\\u00c1LCULO\\r\\n-- Detecta contribuintes com carga tribut\\u00e1ria muito baixa\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise1_icms_baixo;\\r\\nCREATE TABLE teste.gestex_v013_analise1_icms_baixo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.bc_saidas_total,\\r\\n    b.icms_recolher_total,\\r\\n    b.vl_cp_total,\\r\\n    CASE WHEN b.bc_saidas_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.bc_saidas_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_bc,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.icms_recolher_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_icms_faturamento,\\r\\n    'ICMS <= 2% DA BC'                       AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.bc_saidas_total > 0\\r\\n  AND (b.icms_recolher_total / b.bc_saidas_total) <= 0.02\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 2: ENTRADAS COMERCIAIS \\u00d7 SA\\u00cdDAS COMERCIAIS\\r\\n-- Indica poss\\u00edvel uso indevido do CP em produtos revendidos\\r\\n-- Crit\\u00e9rios: (a) Ent.Com \\u2265 20% total entradas\\r\\n--            (b) Raz\\u00e3o Ent.Com/Sa\\u00edda.Com \\u2265 3\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Como a DIME n\\u00e3o detalha por CFOP individual, esta an\\u00e1lise\\r\\n-- usa os totais da DIME (entradas interestaduais como proxy de comerciais).\\r\\n-- Para maior precis\\u00e3o, cruzar com teste.gestex_v013_cfop_efd.\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise2_entradas_comerciais;\\r\\nCREATE TABLE teste.gestex_v013_analise2_entradas_comerciais AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.entradas_internas,\\r\\n    b.entradas_interestaduais,\\r\\n    b.importacao,\\r\\n    (b.entradas_internas + b.entradas_interestaduais + b.importacao) AS total_entradas,\\r\\n    b.saidas_internas,\\r\\n    b.saidas_interestaduais,\\r\\n    b.exportacao,\\r\\n    (b.saidas_internas + b.saidas_interestaduais + b.exportacao) AS total_saidas,\\r\\n    b.vl_cp_total,\\r\\n    -- \\u26a0\\ufe0f Quando houver dados por CFOP, substituir estes c\\u00e1lculos\\r\\n    -- pelos totais reais de CFOPs comerciais vs industriais\\r\\n    'REQUER DETALHAMENTO POR CFOP'           AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE (b.entradas_internas + b.entradas_interestaduais + b.importacao) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 3: CP SEM VENDA DE PRODU\\u00c7\\u00c3O PR\\u00d3PRIA\\r\\n-- Identifica SP que usaram CP sem faturamento com prod. pr\\u00f3pria\\r\\n-- Proxy: faturamento = 0 ou muito baixo relativo ao CP usado\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise3_cp_sem_producao;\\r\\nCREATE TABLE teste.gestex_v013_analise3_cp_sem_producao AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.faturamento_total,\\r\\n    b.receita_bruta_total,\\r\\n    b.vl_cp_total,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    CASE WHEN b.faturamento_total > 0\\r\\n         THEN ROUND(b.vl_cp_total / b.faturamento_total * 100, 4)\\r\\n         ELSE NULL\\r\\n    END                                      AS pct_cp_faturamento,\\r\\n    'CP SEM VENDA PROD. PROPRIA'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nWHERE b.faturamento_total = 0\\r\\n   OR b.faturamento_total IS NULL\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 4: CP CUMULATIVO (TTD47/372 + Simples Nac. ou Extempor\\u00e2neo)\\r\\n-- Identifica uso vedado ou que requer aten\\u00e7\\u00e3o especial\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise4_cp_cumulativo;\\r\\nCREATE TABLE teste.gestex_v013_analise4_cp_cumulativo AS\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.cnae,\\r\\n    b.tipo_cp,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    b.vl_cp_ttd372,\\r\\n    b.vl_cp_total,\\r\\n    b.extempraneo_47,\\r\\n    b.extempraneo_372,\\r\\n    -- Cr\\u00e9ditos extempor\\u00e2neos totais\\r\\n    ext.vl_extempraneo_total,\\r\\n    -- Cr\\u00e9ditos Simples Nacional (via E111)\\r\\n    sn.vl_credito_sn_total,\\r\\n    CASE\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n             AND COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'EXTEMPRANEO + SIMPLES NACIONAL'\\r\\n        WHEN (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n        THEN 'CREDITO EXTEMPRANEO'\\r\\n        WHEN COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n        THEN 'CP + SIMPLES NACIONAL'\\r\\n        ELSE 'NENHUM'\\r\\n    END                                      AS tipo_cumulacao,\\r\\n    'CP CUMULATIVO'                          AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_credito_presumido)            AS vl_extempraneo_total\\r\\n    FROM teste.gestex_v013_dcip\\r\\n    WHERE ind_extempraneo = 1\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) ext ON b.cnpj_raiz = ext.cnpj_raiz AND b.ano = ext.ano\\r\\nLEFT JOIN (\\r\\n    SELECT\\r\\n        cnpj_raiz, ano,\\r\\n        SUM(vl_aj_apur)                     AS vl_credito_sn_total\\r\\n    FROM teste.gestex_v013_efd_e111\\r\\n    WHERE cod_aj_apur LIKE 'SC10%'\\r\\n       OR UPPER(descr_compl_aj) LIKE '%SIMPLES%NACIONAL%'\\r\\n    GROUP BY cnpj_raiz, ano\\r\\n) sn ON b.cnpj_raiz = sn.cnpj_raiz AND b.ano = sn.ano\\r\\nWHERE (b.extempraneo_47 = 1 OR b.extempraneo_372 = 1)\\r\\n   OR COALESCE(sn.vl_credito_sn_total, 0) > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- AN\\u00c1LISE 5: Q9070 + 3% \\u00d7 BC DEVOLU\\u00c7\\u00d5ES = Q14031 (Exclusiva TTD 47)\\r\\n-- Verifica diferen\\u00e7a entre cr\\u00e9ditos permitidos e utilizados\\r\\n-- ================================================================\\r\\n-- \\u26a0\\ufe0f NOTA: Os campos item_9070 e item_14031 s\\u00e3o espec\\u00edficos dos\\r\\n-- quadros Q09 e Q14 da DIME. Na DIME do BigData (vw_ods_decl_dime),\\r\\n-- esses campos podem n\\u00e3o existir como colunas diretas.\\r\\n-- Se necess\\u00e1rio, calcular via E111 ou via tabela DIME espec\\u00edfica.\\r\\n--\\r\\n-- Para BC devolu\\u00e7\\u00f5es: somar C170 com CFOPs 1201, 2201, 1410, 2410\\r\\n-- ================================================================\\r\\nDROP TABLE IF EXISTS teste.gestex_v013_analise5_q9070_q14031;\\r\\nCREATE TABLE teste.gestex_v013_analise5_q9070_q14031 AS\\r\\nWITH devolucoes_venda AS (\\r\\n    SELECT\\r\\n        e.codigocnpj                         AS cnpj,\\r\\n        SUBSTR(e.codigocnpj, 1, 8)          AS cnpj_raiz,\\r\\n        c.ano_referencia                     AS ano,\\r\\n        SUM(c.vl_bc_icms)                   AS bc_devolucoes_venda\\r\\n    FROM efd.efd_rc100 c\\r\\n    INNER JOIN efd.efd e\\r\\n        ON c.id_file = e.id_file\\r\\n        AND c.ano_referencia = e.ano_referencia\\r\\n        AND c.mes_referencia = e.mes_referencia\\r\\n    WHERE c.ano_referencia IN (2020, 2021, 2022, 2023, 2024)\\r\\n      AND c.mes_referencia BETWEEN 1 AND 12\\r\\n      AND c.cod_sit = 0\\r\\n      AND c.ind_oper = 0                    -- Entrada\\r\\n      AND c.cod_mod = '55'                  -- NFe\\r\\n    GROUP BY e.codigocnpj, SUBSTR(e.codigocnpj, 1, 8), c.ano_referencia\\r\\n),\\r\\ndevolucoes_cfop AS (\\r\\n    SELECT\\r\\n        dv.cnpj_raiz,\\r\\n        dv.ano,\\r\\n        dv.bc_devolucoes_venda\\r\\n    FROM devolucoes_venda dv\\r\\n    -- \\u26a0\\ufe0f Idealmente filtrar por CFOP 1201, 2201, 1410, 2410\\r\\n    -- via C170 (listarc170_itensdocumento), mas o vl_bc_icms do C100\\r\\n    -- com ind_oper=0 j\\u00e1 cobre devolu\\u00e7\\u00f5es recebidas.\\r\\n    -- Para maior precis\\u00e3o, usar teste.gestex_v013_cfop_efd\\r\\n    -- filtrando por esses CFOPs espec\\u00edficos.\\r\\n)\\r\\nSELECT\\r\\n    b.cnpj_raiz,\\r\\n    b.razao_social,\\r\\n    b.ano,\\r\\n    b.vl_cp_ttd47,\\r\\n    dc.bc_devolucoes_venda,\\r\\n    0.03 * COALESCE(dc.bc_devolucoes_venda, 0) AS credito_3pct_devolucoes,\\r\\n    -- \\u26a0\\ufe0f Quando tiver os campos Q9070 e Q14031 da DIME, incluir:\\r\\n    -- item_9070 + 0.03 * bc_devolucoes - item_14031 AS diferenca\\r\\n    'REQUER CAMPOS Q9070/Q14031'             AS flag_analise\\r\\nFROM teste.gestex_v013_base_analitica b\\r\\nLEFT JOIN devolucoes_cfop dc\\r\\n    ON b.cnpj_raiz = dc.cnpj_raiz\\r\\n    AND b.ano = dc.ano\\r\\nWHERE b.vl_cp_ttd47 IS NOT NULL\\r\\n  AND b.vl_cp_ttd47 > 0\\r\\n;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- VALIDA\\u00c7\\u00c3O DAS TABELAS CRIADAS\\r\\n-- ================================================================\\r\\n\\r\\nSELECT 'teste.gestex_v013_cadastro' AS tabela, COUNT(*) AS registros FROM teste.gestex_v013_cadastro\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_dados_gerais', COUNT(*) FROM teste.gestex_v013_dime_dados_gerais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dime_anual', COUNT(*) FROM teste.gestex_v013_dime_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e110', COUNT(*) FROM teste.gestex_v013_efd_e110\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_efd_e111', COUNT(*) FROM teste.gestex_v013_efd_e111\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip', COUNT(*) FROM teste.gestex_v013_dcip\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_dcip_anual', COUNT(*) FROM teste.gestex_v013_dcip_anual\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_efd', COUNT(*) FROM teste.gestex_v013_cfop_efd\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_cfop_sumarizada', COUNT(*) FROM teste.gestex_v013_cfop_sumarizada\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_base_analitica', COUNT(*) FROM teste.gestex_v013_base_analitica\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise1_icms_baixo', COUNT(*) FROM teste.gestex_v013_analise1_icms_baixo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise2_entradas_comerciais', COUNT(*) FROM teste.gestex_v013_analise2_entradas_comerciais\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise3_cp_sem_producao', COUNT(*) FROM teste.gestex_v013_analise3_cp_sem_producao\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise4_cp_cumulativo', COUNT(*) FROM teste.gestex_v013_analise4_cp_cumulativo\\r\\nUNION ALL\\r\\nSELECT 'teste.gestex_v013_analise5_q9070_q14031', COUNT(*) FROM teste.gestex_v013_analise5_q9070_q14031\\r\\nORDER BY 1;\\r\\n\\r\\n\\r\\n-- ================================================================\\r\\n-- FIM \\u2014 15 tabelas no schema teste.gestex_v013_*\\r\\n-- ================================================================\\r\\n-- RESUMO DAS TABELAS:\\r\\n--  1. teste.gestex_v013_cadastro              \\u2192 Contribuintes GESTEX ativos\\r\\n--  2. teste.gestex_v013_dime_dados_gerais     \\u2192 DIME mensal (todos campos)\\r\\n--  3. teste.gestex_v013_dime_anual            \\u2192 DIME sumarizada por CNPJ Raiz/ano\\r\\n--  4. teste.gestex_v013_efd_e110              \\u2192 Apura\\u00e7\\u00e3o ICMS (E110) 2020-2024\\r\\n--  5. teste.gestex_v013_efd_e111              \\u2192 Ajustes/benef\\u00edcios (E111)\\r\\n--  6. teste.gestex_v013_dcip                  \\u2192 Cr\\u00e9ditos Presumidos classificados\\r\\n--  7. teste.gestex_v013_dcip_anual            \\u2192 DCIP sumarizada anual\\r\\n--  8. teste.gestex_v013_cfop_efd              \\u2192 Documentos por CFOP (C100/C170)\\r\\n--  9. teste.gestex_v013_cfop_sumarizada       \\u2192 Indicadores por CNPJ Raiz/ano\\r\\n-- 10. teste.gestex_v013_base_analitica        \\u2192 Base cruzada (Cadastro+DIME+DCIP)\\r\\n-- 11. teste.gestex_v013_analise1_icms_baixo   \\u2192 An.1: ICMS \\u2264 2% BC\\r\\n-- 12. teste.gestex_v013_analise2_entradas_com \\u2192 An.2: Ent.Com \\u00d7 Sa\\u00eddas Com\\r\\n-- 13. teste.gestex_v013_analise3_cp_sem_prod  \\u2192 An.3: CP sem produ\\u00e7\\u00e3o\\r\\n-- 14. teste.gestex_v013_analise4_cp_cumul     \\u2192 An.4: CP + SN/extempor\\u00e2neo\\r\\n-- 15. teste.gestex_v013_analise5_q9070_q14031 \\u2192 An.5: Verifica\\u00e7\\u00e3o Q9070/Q14031\\r\\n-- ================================================================\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 676, \"column\": 67}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 804ff7dcdb7dd545:29e743f300000000 100% Complete (69 out of 69)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY 1 ASC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"804ff7dcdb7dd545:29e743f300000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=804ff7dcdb7dd545:29e743f300000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 804ff7dcdb7dd545:29e743f300000000 100% Complete (69 out of 69)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY 1 ASC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"804ff7dcdb7dd545:29e743f300000000\", \"url\": \"/hue/jobbrowser#!id=804ff7dcdb7dd545:29e743f300000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 14038, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 265, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ================================================================\r\n-- GESTEX  Projeto V013: DIME Anlise Anual (20202024)\r\n-- CRIAO DE TABELAS ANALTICAS  BigData Impala/Hue\r\n-- Schema: teste.gestex_v013_*\r\n-- Perodo: 2020 a 2024\r\n-- ================================================================\r\n-- Fontes: usr_sat_ods.vw_ods_decl_dime | usr_sat_ods.vw_ods_contrib\r\n--         efd.efd (hierrquica E110/E111)\r\n--         efd.efd_rc100 / C170 (documentos fiscais)\r\n-- Padro: implicit join para arrays EFD\r\n-- Referncia: Tabelas V014 j validadas (teste.gestex_v014_*)\r\n-- ================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n\r\n-- ================================================================\r\n-- TABELA 1: CADASTRO GESTEX  Contribuintes do setor txtil ativos\r\n-- Fonte: usr_sat_ods.vw_ods_contrib\r\n-- ================================================================\r\n--  NOTA: A lista de CNAEs abaixo deve ser ajustada conforme a\r\n-- planilha CNAE_Subclasses_de_interesse_do_GESTEX.xlsx (coluna GESTEX='SIM').\r\n-- Os CNAEs listados so representativos do setor txtil/confeco.\r\n-- ================================================================\r\nDROP TABLE IF EXISTS teste.gestex_v013_cadastro;\r\nCREATE TABLE teste.gestex_v013_cadastro AS\r\nSELECT\r\n    c.nu_ie                               AS ie,\r\n    c.nu_cnpj                             AS cnpj,\r\n    c.nu_cnpj_grupo                       AS cnpj_raiz,\r\n    c.nm_razao_social                     AS razao_social,\r\n    c.nm_fantasia                         AS nome_fantasia,\r\n    c.cd_cnae                             AS cnae,\r\n    c.de_cnae                             AS cnae_desc,\r\n    c.cd_sit_cadastral                    AS cd_situacao,\r\n    c.nm_sit_cadastral                    AS situacao,\r\n    c.cd_reg_apuracao                     AS cd_regime,\r\n    c.nm_reg_apuracao                     AS regime_tributacao,\r\n    c.cd_enq_empresa                      AS cd_enquadra",
    "last_modified": "2026-02-18T18:11:31.734",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "01ef3fcc-9258-413a-9870-9f72db37f025",
      1,
      false
    ],
    "dependencies": []
  }
}
]
